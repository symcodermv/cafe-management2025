<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gaadiyaa</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    <!-- Export Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Dhivehi Font -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thaana:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Custom font for Dhivehi */
        @font-face {
            font-family: 'Faruma';
            src: url('https://cdn.rawgit.com/Moonster/Faruma/master/fonts/Faruma.woff2') format('woff2'),
                 url('https://cdn.rawgit.com/Moonster/Faruma/master/fonts/Faruma.woff') format('woff'),
                 url('https://cdn.rawgit.com/Moonster/Faruma/master/fonts/Faruma.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', Arial, sans-serif;
            font-family: 'Faruma';
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
            height: 100vh;
            overflow: hidden;
        }
        
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            width: 100vw;
            background: linear-gradient(135deg, #1a311e 0%, #2d4b32 100%);
            position: fixed;
            top: 0;
            left: 0;
            z-index: 10000;
        }
        
        .login-watermark {
            position: absolute;
            bottom: 20px;
            right: 20px;
            color: rgba(255, 255, 255, 0.2);
            font-size: 14px;
            z-index: 10001;
        }
        
        .owner-auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            width: 100vw;
            background: linear-gradient(135deg, #1a311e 0%, #2d4b32 100%);
            position: fixed;
            top: 0;
            left: 0;
            z-index: 10003;
            display: none;
        }
        
        .owner-auth-form {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            width: 100%;
            max-width: 400px;
            z-index: 10004;
            position: relative;
        }
        
        .owner-auth-form h2 {
            text-align: center;
            margin-bottom: 20px;
            color: #4a9e5b;
        }
        
        .welcome-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10001;
            flex-direction: column;
            display: none;
        }
        
        .welcome-text {
            font-family: 'Faruma', 'Noto Sans Thaana', sans-serif;
            font-size: 3.5rem;
            color: #f8a31c;
            text-align: center;
            animation: zoomIn 1.5s ease-in-out, pulse 2s infinite;
            direction: rtl;
            unicode-bidi: bidi-override;
            margin-bottom: 30px;
            text-shadow: 0 0 10px rgba(248, 163, 28, 0.7);
        }
        
        .progress-container {
            width: 300px;
            height: 20px;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            overflow: hidden;
            margin-top: 20px;
        }
        
        .progress-bar {
            height: 100%;
            width: 0%;
            border-radius: 10px;
            background: linear-gradient(90deg, #ff6b6b, #f8a31c, #4a9e5b, #2d4b32);
            background-size: 300% 100%;
            animation: gradientMove 3s infinite, fillBar 3s ease-in-out forwards;
        }
        
        @keyframes zoomIn {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
           100% { transform: scale(1); }
        }
        
        @keyframes gradientMove {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        @keyframes fillBar {
            0% { width: 0%; }
            100% { width: 100%; }
        }
        
        .login-form {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            width: 100%;
            max-width: 400px;
            z-index: 10002;
            position: relative;
        }
        
        .login-form h2 {
            text-align: center;
            margin-bottom: 20px;
            color: #4a9e5b;
        }
        
        .login-form .form-group {
            margin-bottom: 15px;
        }
        
        .login-form label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .login-form input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .login-form button {
            width: 100%;
            padding: 12px;
            background-color: #4a9e5b;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            margin-top: 10px;
        }
        
        .login-form button:hover {
            background-color: #3a7d48;
        }
        
        .owner-options {
            margin-top: 20px;
            text-align: center;
        }
        
        .owner-btn {
            background: none;
            border: none;
            color: #4a9e5b;
            cursor: pointer;
            text-decoration: underline;
            font-size: 14px;
        }
        
        .admin-container {
            display: flex;
            height: 100vh;
            width: 100vw;
            display: none;
        }
        
        /* Sidebar Styles */
        .sidebar {
            width: 250px;
            background-color: #1a311e;
            color: white;
            padding: 20px 0;
            position: fixed;
            height: 100%;
            overflow-y: auto;
            
        }
        
        .sidebar-header {
            padding: 0 20px 20px;
            border-bottom: 1px solid #2d4b32;
            margin-bottom: 20px;
            font-family: 'Faruma';
        }
        
        .sidebar-header h2 {
            color: #f8a31c;
            font-size: 22px;
        }
        
        .sidebar-menu {
            list-style: none;
        }
        
        .sidebar-menu li {
            margin-bottom: 5px;
        }
        
        .sidebar-menu a {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: #ddd;
            text-decoration: none;
            transition: all 0.3s;
        }
        
        .sidebar-menu a:hover, .sidebar-menu a.active {
            background-color: #2d4b32;
            color: white;
        }
        
        .sidebar-menu i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }
        
        /* Main Content Styles */
        .main-content {
            flex: 1;
            margin-left: 250px;
            padding: 20px;
            overflow-y: auto;
            height: 100vh;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #ddd;
        }
        
        .header h1 {
            color: #4a9e5b;
            font-size: 24px;
        }
        
        .logout-btn {
            background-color: #f8a31c;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
        }
        
        .logout-btn:hover {
            background-color: #e5940c;
        }
        
        /* Dashboard Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-card i {
            font-size: 36px;
            color: #4a9e5b;
            margin-bottom: 10px;
        }
        
        .stat-card h3 {
            font-size: 32px;
            margin-bottom: 5px;
            color: #333;
        }
        
        .stat-card p {
            color: #666;
            font-size: 14px;
        }
        
        /* Content Sections */
        .content-section {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .content-section h2 {
            margin-bottom: 15px;
            color: #4a9e5b;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        /* Forms */
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }
        
        .btn {
            background-color: #4a9e5b;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }
        
        .btn:hover {
            background-color: #3a7d48;
        }
        
        .btn-secondary {
            background-color: #f8a31c;
        }
        
        .btn-secondary:hover {
            background-color: #e5940c;
        }
        
        .btn-danger {
            background-color: #dc3545;
        }
        
        .btn-danger:hover {
            background-color: #c82333;
        }
        
        .btn-info {
            background-color: #17a2b8;
        }
        
        .btn-info:hover {
            background-color: #138496;
        }
        
        /* Tables */
        .table-responsive {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        table th, table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        table th {
            background-color: #f9f9f9;
            font-weight: 600;
        }
        
        table tr:hover {
            background-color: #f5f5f5;
        }
        
        .action-buttons {
            display: flex;
            gap: 5px;
        }
        
        .action-buttons button {
            padding: 5px 8px;
            font-size: 12px;
        }
        
        /* Filters */
        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .filter-group label {
            font-weight: 500;
        }
        
        .filter-group input, .filter-group select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        /* Export buttons */
        .export-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            overflow-y: auto;
        }
        
        .modal-content {
            background-color: white;
            margin: 50px auto;
            border-radius: 8px;
            max-width: 800px;
            position: relative;
            animation: modalFadeIn 0.3s;
        }
        
        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 24px;
            color: #333;
            background: none;
            border: none;
            cursor: pointer;
            z-index: 10;
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            position: relative;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .modal-footer {
            padding: 20px;
            border-top: 1px solid #eee;
            text-align: right;
        }
        
        /* Payment slip image */
        .payment-slip {
            max-width: 100%;
            margin-top: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #4a9e5b;
            color: white;
            padding: 15px 20px;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            z-index: 1050;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideIn 0.3s;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .notification-error {
            background-color: #dc3545;
            color: white;
        }
        
        .notification-warning {
            background-color: #ffc107;
            color: #333;
        }
        
        .close-notification {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 16px;
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }
        
        .tab.active {
            border-bottom-color: #4a9e5b;
            color: #4a9e5b;
            font-weight: 500;
        }
        
        /* Tab Content */
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* User Management */
        .user-list {
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .user-card {
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .user-info h3 {
            margin-bottom: 5px;
        }
        
        .user-info p {
            color: #666;
            font-size: 14px;
        }
        
        /* Developer Watermark */
        .developer-watermark {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 100;
        }
        
        /* POS Styles */
        .pos-container {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .pos-products {
            flex: 2;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            max-height: 500px;
            overflow-y: auto;
        }
        
        .pos-product-card {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .pos-product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .pos-product-card img {
            width: 100%;
            height: 100px;
            object-fit: cover;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        
        .pos-product-card h3 {
            font-size: 16px;
            margin-bottom: 5px;
        }
        
        .pos-product-card p {
            color: #4a9e5b;
            font-weight: 500;
        }
        
        .pos-cart {
            flex: 1;
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .pos-cart h3 {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .cart-items {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 15px;
        }
        
        .cart-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        
        .cart-item-info {
            flex: 2;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .cart-item-price {
            flex: 1;
            text-align: right;
            font-weight: 500;
        }
        
        .cart-item-quantity {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .quantity-btn {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            border: none;
            background-color: #f8a31c;
            color: white;
            cursor: pointer;
            font-weight: bold;
        }
        
        .cart-total {
            font-weight: bold;
            font-size: 18px;
            margin: 15px 0;
            text-align: right;
            padding-top: 10px;
            border-top: 2px solid #eee;
        }
        
        .payment-options {
            margin-bottom: 15px;
            display: none; /* Initially hidden */
        }
        
        .payment-option {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .table-selection {
            margin-bottom: 15px;
        }
        
        .table-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .table-btn {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f9f9f9;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }
        
        .table-btn.active {
            background-color: #4a9e5b;
            color: white;
            border-color: #4a9e5b;
        }
        
        .table-btn.occupied {
            background-color: #dc3545;
            color: white;
            border-color: #dc3545;
        }
        
        .pos-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        /* Bill Styles */
        .bill-container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            max-width: 400px;
            margin: 0 auto;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .bill-header {
            text-align: center;
            margin-bottom: 20px;
            font-family: 'Faruma', 'Noto Sans Thaana', sans-serif;
        }
        
        .bill-items {
            margin-bottom: 20px;
        }
        
        .bill-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px dashed #eee;
        }
        
        .bill-total {
            font-weight: bold;
            border-top: 2px solid #ddd;
            padding-top: 10px;
            margin-top: 10px;
            text-align: right;
        }
        
        /* Dhivehi Font Styles */
        .dhivehi-font {
            font-family: 'Faruma', 'Noto Sans Thaana', sans-serif;
            font-size: 16px;
            line-height: 1.5;
            direction: rtl;
            unicode-bidi: bidi-override;
        }
        
        .product-name-dhivehi {
            font-family: 'Faruma', 'Noto Sans Thaana', sans-serif;
            font-size: 16px;
            direction: rtl;
            unicode-bidi: bidi-override;
        }
        
        .dhivehi-input {
            font-family: 'Faruma', 'Noto Sans Thaana', sans-serif;
            font-size: 16px;
            direction: rtl;
            unicode-bidi: bidi-override;
        }
        
        .category-name-dhivehi {
            font-family: 'Faruma', 'Noto Sans Thaana', sans-serif;
            font-size: 14px;
            direction: rtl;
            unicode-bidi: bidi-override;
        }
        
        /* Stock Management Styles */
        .stock-info {
            background-color: #f8f9fa;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            margin-top: 5px;
        }
        
        .stock-low {
            color: #dc3545;
            font-weight: bold;
        }
        
        .stock-edit-form {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 10px;
        }
        
        .stock-edit-form input {
            width: 80px;
        }
        
        /* POS Category Filter */
        .category-filter {
            margin-bottom: 15px;
        }
        
        .category-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .category-btn {
            padding: 8px 15px;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .category-btn.active {
            background-color: #4a9e5b;
            color: white;
            border-color: #4a9e5b;
        }
        
        /* Settings Panel */
        .settings-panel {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .settings-group {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .settings-group h3 {
            margin-bottom: 15px;
            color: #4a9e5b;
        }
        
        /* Expenses Management */
        .expense-form {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        /* Reports Section */
        .reports-section {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .report-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .report-type {
            margin-bottom: 20px;
        }
        
        .report-type h3 {
            margin-bottom: 10px;
            color: #4a9e5b;
        }
        
        .report-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        /* Credit Management Styles */
        .credit-customer-card {
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .credit-status {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-paid {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status-pending {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .status-overdue {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .credit-details {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }
        
        .payment-history {
            margin-top: 15px;
        }
        
        .payment-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        
        .payment-form {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                position: relative;
                height: auto;
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .filters {
                flex-direction: column;
            }
            
            .pos-container {
                flex-direction: column;
            }
            
            .category-buttons {
                justify-content: center;
            }
            
            .welcome-text {
                font-size: 2rem;
            }
        }

        /* Credit Customer Selection Styles */
        .customer-selection {
            margin-bottom: 15px;
        }
        
        .customer-search {
            position: relative;
        }
        
        .customer-search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            display: none;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .customer-search-result {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s;
        }
        
        .customer-search-result:hover {
            background-color: #f0f8ff;
        }
        
        .selected-customer {
            background-color: #e8f5e9;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            display: none;
        }
        
        .credit-limit-info {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .credit-limit-warning {
            color: #dc3545;
            font-weight: bold;
        }
        
        /* Credit Invoice Styles */
        .credit-invoice {
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .invoice-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }
        
        .invoice-items {
            margin-bottom: 10px;
        }
        
        .invoice-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }
        
        .invoice-total {
            font-weight: bold;
            text-align: right;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #ddd;
        }
        
        .invoice-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        /* Customer Info Form */
        .customer-info-form {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        /* Quick Actions */
        .quick-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        /* Enhanced POS Styles */
        .customer-type-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .customer-type-btn {
            padding: 8px 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f8f9fa;
            cursor: pointer;
        }
        
        .customer-type-btn.active {
            background-color: #4a9e5b;
            color: white;
            border-color: #4a9e5b;
        }
        
        .customer-details-form {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        /* Enhanced Credit Management */
        .credit-summary-card {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .credit-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        /* Enhanced Table Styles */
        .table-row-highlight {
            background-color: #f8f9fa !important;
        }
        
        .table-action-cell {
            white-space: nowrap;
        }
    </style>
</head>
<body>
    <!-- Welcome Animation -->
    <div id="welcomeOverlay" class="welcome-overlay">
        <div class="welcome-text">ގާޑިޔާ މެނޭޖްމަންޓް ސިސްޓަމް</div>
        <div class="progress-container">
            <div class="progress-bar"></div>
        </div>
    </div>

    <!-- Owner Authentication Screen -->
    <div id="ownerAuthScreen" class="owner-auth-container">
        <div class="owner-auth-form">
            <h2>Owner Authentication</h2>
            <div class="form-group">
                <label for="ownerPassword">Enter Owner Password</label>
                <input type="password" id="ownerPassword" placeholder="Enter owner password">
            </div>
            <button class="btn" id="submitOwnerPassword">Submit</button>
            <div class="login-watermark">Developed by sym.codermv © 2025</div>
        </div>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-form">
            <h2>Gaadiyaa Admin Login</h2>
            <div class="form-group">
                <label for="username">Username</label>
                <input type="text" id="username" placeholder="Enter your username">
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" placeholder="Enter your password">
            </div>
            <button class="btn" id="loginBtn">Login</button>
            
            <div class="owner-options">
                <button class="owner-btn" id="ownerBtn">Owner Options</button>
            </div>
        </div>
        <div class="login-watermark">Developed by sym.codermv © 2025</div>
    </div>

    <!-- Owner Modal -->
    <div id="ownerModal" class="modal">
        <div class="modal-content">
            <button class="close-modal" id="closeOwnerModal">
                <i class="fas fa-times"></i>
            </button>
            <div class="modal-header">
                <h2>Owner Options</h2>
            </div>
            <div class="modal-body">
                <div class="tabs">
                    <div class="tab active" data-subtab="create-user">Create User</div>
                    <div class="tab" data-subtab="user-list">User List</div>
                    <div class="tab" data-subtab="settings">Settings</div>
                </div>
                
                <div id="create-user" class="tab-content active">
                    <form id="createUserForm">
                        <div class="form-group">
                            <label for="newUsername">Username</label>
                            <input type="text" id="newUsername" required>
                        </div>
                        <div class="form-group">
                            <label for="newPassword">Password</label>
                            <input type="password" id="newPassword" required>
                        </div>
                        <div class="form-group">
                            <label for="userRole">Role</label>
                            <select id="userRole" required>
                                <option value="admin">Admin</option>
                                <option value="manager">Manager</option>
                                <option value="staff">Staff</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Access Control</label>
                            <div>
                                <label><input type="checkbox" name="access" value="dashboard" checked> Dashboard</label>
                            </div>
                            <div>
                                <label><input type="checkbox" name="access" value="orders" checked> Orders</label>
                            </div>
                            <div>
                                <label><input type="checkbox" name="access" value="products" checked> Products</label>
                            </div>
                            <div>
                                <label><input type="checkbox" name="access" value="categories" checked> Categories</label>
                            </div>
                            <div>
                                <label><input type="checkbox" name="access" value="pos"> POS System</label>
                            </div>
                            <div>
                                <label><input type="checkbox" name="access" value="stock"> Stock Management</label>
                            </div>
                            <div>
                                <label><input type="checkbox" name="access" value="expenses"> Expenses Management</label>
                            </div>
                            <div>
                                <label><input type="checkbox" name="access" value="credit"> Credit Management</label>
                            </div>
                        </div>
                        <button type="submit" class="btn">Create User</button>
                    </form>
                </div>
                
                <div id="user-list" class="tab-content">
                    <div class="user-list" id="userListContainer">
                        <!-- Users will be loaded here -->
                    </div>
                </div>
                
                <div id="settings" class="tab-content">
                    <div class="settings-group">
                        <h3>Table Settings</h3>
                        <div class="form-group">
                            <label for="tableCount">Number of Tables</label>
                            <input type="number" id="tableCount" min="1" max="50" value="10">
                        </div>
                        <button class="btn" id="saveTableSettings">Save Table Settings</button>
                    </div>
                    
                    <div class="settings-group">
                        <h3>Invoice/Bill Settings</h3>
                        <div class="form-group">
                            <label for="invoiceName">Invoice/Bill Header Name</label>
                            <input type="text" id="invoiceName" placeholder="Enter business name for invoices">
                        </div>
                        <button class="btn" id="saveInvoiceSettings">Save Invoice Settings</button>
                    </div>
                    
                    <div class="settings-group">
                        <h3>Credit Settings</h3>
                        <div class="form-group">
                            <label for="defaultCreditDays">Default Credit Days</label>
                            <input type="number" id="defaultCreditDays" min="1" value="30">
                        </div>
                        <div class="form-group">
                            <label for="overduePenalty">Overdue Penalty Percentage</label>
                            <input type="number" id="overduePenalty" min="0" step="0.1" value="5.0">
                        </div>
                        <button class="btn" id="saveCreditSettings">Save Credit Settings</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="adminPanel" class="admin-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>ގާޑިޔާ އެޑްމިން</h2>
            </div>
             <ul class="sidebar-menu">
                <li><a href="#" class="active" data-tab="dashboard"><i class="fas fa-tachometer-alt"></i> ޑޭޝްބޯޑް</a></li>
                <li><a href="#" data-tab="pos"><i class="fas fa-cash-register"></i> ވިއްކުމުގެ ނިޒާމް</a></li>
                <li><a href="#" data-tab="orders"><i class="fas fa-shopping-cart"></i>ވިއްކުންތައް ބެލެހެއްޓުން</a></li>
                <li><a href="#" data-tab="products"><i class="fas fa-glass"></i> އައިޓަމް</a></li>
                <li><a href="#" data-tab="categories"><i class="fas fa-tags"></i> ބާވަތްތައް ބެލެހެއްޓުން</a></li>
                <li><a href="#" data-tab="stock"><i class="fas fa-boxes"></i> ސްޓޮކް ބެލެހެއްޓުން</a></li>
                <li><a href="#" data-tab="expenses"><i class="fas fa-money-bill"></i> ޚަރަތުތައް ބެލެހެއްޓުން</a></li>
                <li><a href="#" data-tab="credit"><i class="fas fa-credit-card"></i> ކްރެޑިޓް ބެލެހެއްޓުން</a></li>
                <li><a href="#" data-tab="reports"><i class="fas fa-chart-bar"></i> ރިޕޯޓް</a></li>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="header">
                <h1>Admin Dashboard</h1>
                <div>
                    <span id="currentUserInfo" style="margin-right: 15px;"></span>
                    <button class="logout-btn" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</button>
                </div>
            </div>

            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <i class="fas fa-shopping-cart"></i>
                        <h3 id="totalOrders">0</h3>
                        <p>Total Orders</p>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-coins"></i>
                        <h3 id="totalRevenue">Rf 0</h3>
                        <p>Total Revenue</p>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-check-circle"></i>
                        <h3 id="completedOrders">0</h3>
                        <p>Completed Orders</p>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-pause-circle"></i>
                        <h3 id="heldOrdersCount">0</h3>
                        <p>Held Orders</p>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-money-bill-wave"></i>
                        <h3 id="totalExpenses">Rf 0</h3>
                        <p>Total Expenses</p>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-chart-line"></i>
                        <h3 id="netProfit">Rf 0</h3>
                        <p>Net Profit</p>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-credit-card"></i>
                        <h3 id="totalCredit">Rf 0</h3>
                        <p>Credit Sales</p>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-clock"></i>
                        <h3 id="pendingCredit">Rf 0</h3>
                        <p>Pending Credit</p>
                    </div>
                </div>

                <div class="content-section">
                    <h2>Quick Reports</h2>
                    <div class="filters">
                        <div class="filter-group">
                            <label for="dashboardDateFrom">From:</label>
                            <input type="date" id="dashboardDateFrom">
                        </div>
                        <div class="filter-group">
                            <label for="dashboardDateTo">To:</label>
                            <input type="date" id="dashboardDateTo">
                        </div>
                        <div class="filter-group">
                            <button class="btn" id="dashboardFilterBtn">Filter</button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table id="dashboardSummaryTable">
                            <thead>
                                <tr>
                                    <th>Metric</th>
                                    <th>Value</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Total Sales</td>
                                    <td id="dashboardTotalSales">Rf 0.00</td>
                                </tr>
                                <tr>
                                    <td>Total Expenses</td>
                                    <td id="dashboardTotalExpenses">Rf 0.00</td>
                                </tr>
                                <tr>
                                    <td>Net Profit</td>
                                    <td id="dashboardNetProfit">Rf 0.00</td>
                                </tr>
                                <tr>
                                    <td>Number of Orders</td>
                                    <td id="dashboardOrderCount">0</td>
                                </tr>
                                <tr>
                                    <td>Credit Sales</td>
                                    <td id="dashboardCreditSales">Rf 0.00</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- POS System Tab -->
            <div id="pos" class="tab-content">
                <div class="content-section">
                    <h2>Point of Sale (POS) System</h2>
                    <div class="category-filter">
                        <label>Filter by Category:</label>
                        <div class="category-buttons" id="categoryButtons">
                            <button class="category-btn active" data-category="all">All</button>
                            <!-- Category buttons will be loaded here -->
                        </div>
                    </div>
                    <div class="pos-container">
                        <div class="pos-products" id="posProducts">
                            <!-- Products will be loaded here -->
                        </div>
                        <div class="pos-cart">
                            <h3>Current Order</h3>
                            <div class="table-selection">
                                <label>Table Number:</label>
                                <div class="table-grid" id="tableGrid">
                                    <!-- Tables will be loaded here -->
                                </div>
                            </div>
                            
                            <!-- Customer Type Selection -->
                            <div class="customer-type-selector">
                                <button type="button" class="customer-type-btn active" data-customer-type="regular">Regular Customer</button>
                                <button type="button" class="customer-type-btn" data-customer-type="credit">Credit Customer</button>
                            </div>
                            
                            <!-- Regular Customer Form -->
                            <div id="regularCustomerForm" class="customer-details-form">
                                <div class="form-group">
                                    <label for="customerNameInput">Customer Name (Optional)</label>
                                    <input type="text" id="customerNameInput" placeholder="Enter customer name">
                                </div>
                                <div class="form-group">
                                    <label for="customerPhoneInput">Phone Number (Optional)</label>
                                    <input type="text" id="customerPhoneInput" placeholder="Enter phone number">
                                </div>
                            </div>
                            
                            <!-- Credit Customer Selection -->
                            <div id="creditCustomerSection" class="customer-selection" style="display: none;">
                                <label for="customerSearch">Search Credit Customer:</label>
                                <div class="customer-search">
                                    <input type="text" id="customerSearch" placeholder="Search by name or phone">
                                    <div class="customer-search-results" id="customerSearchResults"></div>
                                </div>
                                <div class="selected-customer" id="selectedCustomer">
                                    <div id="customerInfo"></div>
                                    <div class="credit-limit-info" id="creditLimitInfo"></div>
                                    <button type="button" class="btn btn-secondary" id="clearCustomerBtn">Clear Customer</button>
                                </div>
                            </div>
                            
                            <div class="cart-items" id="cartItems">
                                <!-- Cart items will be displayed here -->
                                <p class="empty-cart">No items added yet</p>
                            </div>
                            <div class="cart-total" id="cartTotal">
                                Total: Rf 0.00
                            </div>
                            <div class="payment-options">
                                <label>Payment Method:</label>
                                <div class="payment-option">
                                    <input type="radio" id="cashPayment" name="paymentMethod" value="cash" checked>
                                    <label for="cashPayment">Cash</label>
                                </div>
                                <div class="payment-option">
                                    <input type="radio" id="bankTransfer" name="paymentMethod" value="bank-transfer">
                                    <label for="bankTransfer">Bank Transfer</label>
                                </div>
                                <div class="payment-option">
                                    <input type="radio" id="creditPayment" name="paymentMethod" value="credit">
                                    <label for="creditPayment">Credit</label>
                                </div>
                            </div>
                            <div class="pos-actions">
                                <button class="btn btn-danger" id="clearCartBtn">Clear</button>
                                <button class="btn btn-secondary" id="holdOrderBtn">Hold Order</button>
                                <button class="btn" id="completeOrderBtn">Complete Order</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="content-section">
                    <h2>Held Orders</h2>
                    <div class="table-responsive">
                        <table id="heldOrdersTable">
                            <thead>
                                <tr>
                                    <th>Table #</th>
                                    <th>Customer Phone</th>
                                    <th>Items</th>
                                    <th>Total</th>
                                    <th>Time</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Held orders will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Orders Tab -->
            <div id="orders" class="tab-content">
                <div class="content-section">
                    <h2>Order Management</h2>
                    <div class="filters">
                        <div class="filter-group">
                            <label for="orderStatusFilter">Status:</label>
                            <select id="orderStatusFilter">
                                <option value="">All</option>
                                <option value="pending">Pending</option>
                                <option value="preparing">Preparing</option>
                                <option value="on-the-way">On the Way</option>
                                <option value="delivered">Delivered</option>
                                <option value="cancelled">Cancelled</option>
                                <option value="completed">Completed</option>
                                <option value="held">Held</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="orderDateFrom">From:</label>
                            <input type="date" id="orderDateFrom">
                        </div>
                        <div class="filter-group">
                            <label for="orderDateTo">To:</label>
                            <input type="date" id="orderDateTo">
                        </div>
                        <div class="filter-group">
                            <button class="btn" id="filterOrdersBtn">Filter</button>
                        </div>
                        <div class="filter-group">
                            <button class="btn btn-secondary" id="exportOrdersExcelBtn">Export Excel</button>
                        </div>
                        <div class="filter-group">
                            <button class="btn btn-secondary" id="exportOrdersPdfBtn">Export PDF</button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table id="ordersTable">
                            <thead>
                                <tr>
                                    <th>Order #</th>
                                    <th>Customer</th>
                                    <th>Phone</th>
                                    <th>Date</th>
                                    <th>Amount</th>
                                    <th>Payment Method</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Orders will be loaded here -->
                            </tbody>
                            <tfoot id="ordersTableFooter">
                                <!-- Subtotal row will be added here -->
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Products Tab -->
            <div id="products" class="tab-content">
                <div class="content-section">
                    <h2>Product Management</h2>
                    <div class="tabs">
                        <div class="tab active" data-subtab="product-list">Product List</div>
                        <div class="tab" data-subtab="add-product">Add New Product</div>
                    </div>

                    <div id="product-list" class="tab-content active">
                        <div class="table-responsive">
                            <table id="productsTable">
                                <thead>
                                    <tr>
                                        <th>Image</th>
                                        <th>Name</th>
                                        <th>Category</th>
                                        <th>Price</th>
                                        <th>Stock</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Products will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div id="add-product" class="tab-content">
                        <form id="addProductForm">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="productName">Product Name (Dhivehi)</label>
                                    <input type="text" id="productName" class="dhivehi-input" required>
                                </div>
                                <div class="form-group">
                                    <label for="productCategory">Category</label>
                                    <select id="productCategory" required>
                                        <option value="">Select Category</option>
                                        <!-- Categories will be loaded here -->
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="productPrice">Price (Rf)</label>
                                    <input type="number" id="productPrice" min="0" step="0.01" required>
                                </div>
                                <div class="form-group">
                                    <label for="productStock">Initial Stock</label>
                                    <input type="number" id="productStock" min="0" value="0" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="productImage">Image URL</label>
                                <input type="text" id="productImage" required>
                            </div>
                            <button type="submit" class="btn">Add Product</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Categories Tab -->
            <div id="categories" class="tab-content">
                <div class="content-section">
                    <h2>Category Management</h2>
                    <div class="tabs">
                        <div class="tab active" data-subtab="category-list">Category List</div>
                        <div class="tab" data-subtab="add-category">Add New Category</div>
                    </div>

                    <div id="category-list" class="tab-content active">
                        <div class="table-responsive">
                            <table id="categoriesTable">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Categories will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div id="add-category" class="tab-content">
                        <form id="addCategoryForm">
                            <div class="form-group">
                                <label for="categoryName">Category Name (Dhivehi)</label>
                                <input type="text" id="categoryName" class="dhivehi-input" required>
                            </div>
                            <button type="submit" class="btn">Add Category</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Stock Management Tab -->
            <div id="stock" class="tab-content">
                <div class="content-section">
                    <h2>Stock Management</h2>
                    <div class="filters">
                        <div class="filter-group">
                            <label for="stockCategoryFilter">Category:</label>
                            <select id="stockCategoryFilter">
                                <option value="">All Categories</option>
                                <!-- Categories will be loaded here -->
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="stockStatusFilter">Stock Status:</label>
                            <select id="stockStatusFilter">
                                <option value="">All</option>
                                <option value="low">Low Stock</option>
                                <option value="out">Out of Stock</option>
                                <option value="in">In Stock</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <button class="btn" id="filterStockBtn">Filter</button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table id="stockTable">
                            <thead>
                                <tr>
                                    <th>Image</th>
                                    <th>Name</th>
                                    <th>Category</th>
                                    <th>Current Stock</th>
                                    <th>Price</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Stock data will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Expenses Tab -->
            <div id="expenses" class="tab-content">
                <div class="content-section">
                    <h2>Expenses Management</h2>
                    <div class="tabs">
                        <div class="tab active" data-subtab="add-expense">Add Expense</div>
                        <div class="tab" data-subtab="expense-list">Expense List</div>
                    </div>

                    <div id="add-expense" class="tab-content active">
                        <form id="addExpenseForm" class="expense-form">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="expenseDate">Date</label>
                                    <input type="date" id="expenseDate" required>
                                </div>
                                <div class="form-group">
                                    <label for="expenseSupplier">Supplier</label>
                                    <input type="text" id="expenseSupplier" required>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="expenseInvoice">Invoice Number</label>
                                    <input type="text" id="expenseInvoice" required>
                                </div>
                                <div class="form-group">
                                    <label for="expensePurpose">Purpose</label>
                                    <input type="text" id="expensePurpose" required>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="expenseAmount">Amount (Rf)</label>
                                    <input type="number" id="expenseAmount" min="0" step="0.01" required>
                                </div>
                                <div class="form-group">
                                    <label for="expenseNotes">Notes</label>
                                    <textarea id="expenseNotes"></textarea>
                                </div>
                            </div>
                            <button type="submit" class="btn">Add Expense</button>
                        </form>
                    </div>

                    <div id="expense-list" class="tab-content">
                        <div class="filters">
                            <div class="filter-group">
                                <label for="expenseDateFrom">From:</label>
                                <input type="date" id="expenseDateFrom">
                            </div>
                            <div class="filter-group">
                                <label for="expenseDateTo">To:</label>
                                <input type="date" id="expenseDateTo">
                            </div>
                            <div class="filter-group">
                                <button class="btn" id="filterExpensesBtn">Filter</button>
                            </div>
                            <div class="filter-group">
                                <button class="btn btn-secondary" id="exportExpensesExcelBtn">Export Excel</button>
                            </div>
                            <div class="filter-group">
                                <button class="btn btn-secondary" id="exportExpensesPdfBtn">Export PDF</button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table id="expensesTable">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Supplier</th>
                                        <th>Invoice #</th>
                                        <th>Purpose</th>
                                        <th>Amount</th>
                                        <th>Notes</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Expenses will be loaded here -->
                                </tbody>
                                <tfoot id="expensesTableFooter">
                                    <!-- Total row will be added here -->
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Credit Management Tab -->
            <div id="credit" class="tab-content">
                <div class="content-section">
                    <h2>Credit Management</h2>
                    <div class="tabs">
                        <div class="tab active" data-subtab="customers">Customers</div>
                        <div class="tab" data-subtab="add-customer">Add Customer</div>
                        <div class="tab" data-subtab="credit-transactions">Credit Transactions</div>
                    </div>

                    <div id="customers" class="tab-content active">
                        <div class="filters">
                            <div class="filter-group">
                                <label for="customerStatusFilter">Status:</label>
                                <select id="customerStatusFilter">
                                    <option value="">All</option>
                                    <option value="active">Active</option>
                                    <option value="inactive">Inactive</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <button class="btn" id="filterCustomersBtn">Filter</button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table id="customersTable">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Contact</th>
                                        <th>Credit Limit</th>
                                        <th>Outstanding</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Customers will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div id="add-customer" class="tab-content">
                        <form id="addCustomerForm">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="customerName">Customer Name</label>
                                    <input type="text" id="customerName" required>
                                </div>
                                <div class="form-group">
                                    <label for="customerContact">Contact Number</label>
                                    <input type="text" id="customerContact" required>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="customerAddress">Address (Optional)</label>
                                    <textarea id="customerAddress"></textarea>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="creditLimit">Credit Limit (Rf)</label>
                                    <input type="number" id="creditLimit" min="0" step="0.01" required>
                                </div>
                                <div class="form-group">
                                    <label for="creditDays">Credit Days</label>
                                    <input type="number" id="creditDays" min="1" value="30" required>
                                </div>
                            </div>
                            <button type="submit" class="btn">Add Customer</button>
                        </form>
                    </div>

                    <div id="credit-transactions" class="tab-content">
                        <div class="filters">
                            <div class="filter-group">
                                <label for="creditStatusFilter">Payment Status:</label>
                                <select id="creditStatusFilter">
                                    <option value="">All</option>
                                    <option value="pending">Pending</option>
                                    <option value="partial">Partially Paid</option>
                                    <option value="paid">Paid</option>
                                    <option value="overdue">Overdue</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="creditDateFrom">From:</label>
                                <input type="date" id="creditDateFrom">
                            </div>
                            <div class="filter-group">
                                <label for="creditDateTo">To:</label>
                                <input type="date" id="creditDateTo">
                            </div>
                            <div class="filter-group">
                                <button class="btn" id="filterCreditBtn">Filter</button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table id="creditTable">
                                <thead>
                                    <tr>
                                        <th>Invoice #</th>
                                        <th>Customer</th>
                                        <th>Date</th>
                                        <th>Amount</th>
                                        <th>Paid</th>
                                        <th>Due</th>
                                        <th>Due Date</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Credit transactions will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reports Tab -->
            <div id="reports" class="tab-content">
                <div class="content-section">
                    <h2>Financial Reports</h2>
                    <div class="report-filters">
                        <div class="form-group">
                            <label for="reportDateFrom">From Date:</label>
                            <input type="date" id="reportDateFrom">
                        </div>
                        <div class="form-group">
                            <label for="reportDateTo">To Date:</label>
                            <input type="date" id="reportDateTo">
                        </div>
                        <div class="form-group">
                            <button class="btn" id="generateReportBtn">Generate Report</button>
                        </div>
                    </div>

                    <div class="report-type">
                        <h3>Sales Report</h3>
                        <div class="table-responsive">
                            <table id="salesReportTable">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Order #</th>
                                        <th>Customer</th>
                                        <th>Amount (Rf)</th>
                                        <th>Payment Method</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Sales report data will be loaded here -->
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <td colspan="3" style="text-align: right; font-weight: bold;">Total Sales:</td>
                                        <td id="salesReportTotal" style="font-weight: bold;">Rf 0.00</td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        <div class="report-actions">
                            <button class="btn btn-secondary" id="exportSalesReportExcelBtn">Export Excel</button>
                            <button class="btn btn-secondary" id="exportSalesReportPdfBtn">Export PDF</button>
                        </div>
                    </div>

                    <div class="report-type">
                        <h3>Expenses Report</h3>
                        <div class="table-responsive">
                            <table id="expensesReportTable">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Supplier</th>
                                        <th>Purpose</th>
                                        <th>Amount (Rf)</th>
                                        <th>Invoice #</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Expenses report data will be loaded here -->
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <td colspan="3" style="text-align: right; font-weight: bold;">Total Expenses:</td>
                                        <td id="expensesReportTotal" style="font-weight: bold;">Rf 0.00</td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        <div class="report-actions">
                            <button class="btn btn-secondary" id="exportExpensesReportExcelBtn">Export Excel</button>
                            <button class="btn btn-secondary" id="exportExpensesReportPdfBtn">Export PDF</button>
                        </div>
                    </div>

                    <div class="report-type">
                        <h3>Credit Report</h3>
                        <div class="table-responsive">
                            <table id="creditReportTable">
                                <thead>
                                    <tr>
                                        <th>Customer</th>
                                        <th>Total Credit</th>
                                        <th>Paid</th>
                                        <th>Due</th>
                                        <th>Overdue</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Credit report data will be loaded here -->
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <td style="font-weight: bold;">Total:</td>
                                        <td id="creditReportTotal" style="font-weight: bold;">Rf 0.00</td>
                                        <td id="creditReportPaid" style="font-weight: bold;">Rf 0.00</td>
                                        <td id="creditReportDue" style="font-weight: bold;">Rf 0.00</td>
                                        <td id="creditReportOverdue" style="font-weight: bold;">Rf 0.00</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        <div class="report-actions">
                            <button class="btn btn-secondary" id="exportCreditReportExcelBtn">Export Excel</button>
                            <button class="btn btn-secondary" id="exportCreditReportPdfBtn">Export PDF</button>
                        </div>
                    </div>

                    <div class="report-type">
                        <h3>Balance Sheet</h3>
                        <div id="balanceSheet">
                            <div class="table-responsive">
                                <table id="balanceSheetTable">
                                    <thead>
                                        <tr>
                                            <th>Description</th>
                                            <th>Amount (Rf)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>Total Revenue</td>
                                            <td id="balanceSheetRevenue">Rf 0.00</td>
                                        </tr>
                                        <tr>
                                            <td>Total Expenses</td>
                                            <td id="balanceSheetExpenses">Rf 0.00</td>
                                        </tr>
                                        <tr>
                                            <td>Credit Sales</td>
                                            <td id="balanceSheetCredit">Rf 0.00</td>
                                        </tr>
                                        <tr>
                                            <td>Pending Credit</td>
                                            <td id="balanceSheetPending">Rf 0.00</td>
                                        </tr>
                                        <tr>
                                            <td style="font-weight: bold;">Net Profit</td>
                                            <td id="balanceSheetNetProfit" style="font-weight: bold;">Rf 0.00</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="report-actions">
                                <button class="btn btn-secondary" id="exportBalanceSheetExcelBtn">Export Excel</button>
                                <button class="btn btn-secondary" id="exportBalanceSheetPdfBtn">Export PDF</button>
                            </div>
                            </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Order Detail Modal -->
    <div id="orderModal" class="modal">
        <div class="modal-content">
            <button class="close-modal" id="closeOrderModal">
                <i class="fas fa-times"></i>
            </button>
            <div class="modal-header">
                <h2>Order Details</h2>
            </div>
            <div class="modal-body" id="orderModalBody">
                <!-- Order details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-info" id="creditOrderBtn" style="display: none;">Send to Credit</button>
                <button class="btn btn-danger" id="deleteOrderBtn">Delete Order</button>
                <button class="btn" id="closeOrderModalBtn">Close</button>
            </div>
        </div>
    </div>

    <!-- Stock Edit Modal -->
    <div id="stockModal" class="modal">
        <div class="modal-content">
            <button class="close-modal" id="closeStockModal">
                <i class="fas fa-times"></i>
            </button>
            <div class="modal-header">
                <h2>Edit Stock & Price</h2>
            </div>
            <div class="modal-body" id="stockModalBody">
                <!-- Stock edit form will be loaded here -->
            </div>
            <div class="modal-footer">
                <button class="btn" id="saveStockBtn">Save Changes</button>
                <button class="btn btn-secondary" id="closeStockModalBtn">Close</button>
            </div>
        </div>
    </div>

    <!-- Bill Modal -->
    <div id="billModal" class="modal">
        <div class="modal-content">
            <button class="close-modal" id="closeBillModal">
                <i class="fas fa-times"></i>
            </button>
            <div class="modal-header">
                <h2 id="billModalTitle">Order Bill</h2>
            </div>
            <div class="modal-body" id="billModalBody">
                <!-- Bill will be loaded here -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="printBillBtn">Print Bill</button>
                <button class="btn" id="closeBillModalBtn">Close</button>
            </div>
        </div>
    </div>

    <!-- Credit Payment Modal -->
    <div id="creditPaymentModal" class="modal">
        <div class="modal-content">
            <button class="close-modal" id="closeCreditPaymentModal">
                <i class="fas fa-times"></i>
            </button>
            <div class="modal-header">
                <h2>Record Payment</h2>
            </div>
            <div class="modal-body" id="creditPaymentModalBody">
                <!-- Payment form will be loaded here -->
            </div>
            <div class="modal-footer">
                <button class="btn" id="savePaymentBtn">Save Payment</button>
                <button class="btn btn-secondary" id="closeCreditPaymentModalBtn">Close</button>
            </div>
        </div>
    </div>

    <!-- Customer Detail Modal -->
    <div id="customerModal" class="modal">
        <div class="modal-content">
            <button class="close-modal" id="closeCustomerModal">
                <i class="fas fa-times"></i>
            </button>
            <div class="modal-header">
                <h2>Customer Details</h2>
            </div>
            <div class="modal-body" id="customerModalBody">
                <!-- Customer details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-info" id="addPaymentBtn">Add Payment</button>
                <button class="btn btn-secondary" id="closeCustomerModalBtn">Close</button>
            </div>
        </div>
    </div>

    <!-- Credit Customer Detail Modal -->
    <div id="creditCustomerModal" class="modal">
        <div class="modal-content">
            <button class="close-modal" id="closeCreditCustomerModal">
                <i class="fas fa-times"></i>
            </button>
            <div class="modal-header">
                <h2>Credit Customer Details</h2>
            </div>
            <div class="modal-body" id="creditCustomerModalBody">
                <!-- Credit customer details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="closeCreditCustomerModalBtn">Close</button>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notificationContainer"></div>

    <!-- Developer Watermark -->
    <div class="developer-watermark">
        Developed by sym.codermv © 2025
    </div>

    <script>
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
            apiKey: "AIzaSyAmy836Pc3NBJfqv7ovKeLuXEroEKKljes",
            authDomain: "delivery-d07af.firebaseapp.com",
            databaseURL: "https://delivery-d07af-default-rtdb.firebaseio.com",
            projectId: "delivery-d07af",
            storageBucket: "delivery-d07af.firebasestorage.app",
            messagingSenderId: "18177223806",
            appId: "1:18177223806:web:e09f3abf45b6d25fc2fc2f",
            measurementId: "G-V7TC88WW4L"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Global variables
        let currentOrderId = null;
        let currentUser = null;
        let userAccess = [];
        let cart = [];
        let currentTable = null;
        let tablesCount = 10;
        let heldOrders = {};
        let notifiedOrders = {}; // Track which orders have been notified
        let currentEditingProductId = null; // For stock management
        let selectedCategory = 'all'; // For POS category filtering
        let invoiceName = "Scorpiora"; // Default invoice name
        let defaultCreditDays = 30; // Default credit days
        let overduePenalty = 5.0; // Default overdue penalty percentage
        let currentCreditCustomerId = null; // For credit management
        let currentCreditInvoiceId = null; // For credit payment
        let selectedCustomer = null; // For POS customer selection
        let customerType = 'regular'; // 'regular' or 'credit'

        // DOM elements
        const ownerAuthScreen = document.getElementById('ownerAuthScreen');
        const loginScreen = document.getElementById('loginScreen');
        const adminPanel = document.getElementById('adminPanel');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const loginBtn = document.getElementById('loginBtn');
        const ownerBtn = document.getElementById('ownerBtn');
        const ownerModal = document.getElementById('ownerModal');
        const submitOwnerPassword = document.getElementById('submitOwnerPassword');
        const createUserForm = document.getElementById('createUserForm');
        const logoutBtn = document.getElementById('logoutBtn');
        const sidebarLinks = document.querySelectorAll('.sidebar-menu a');
        const tabContents = document.querySelectorAll('.tab-content');
        const subtabTabs = document.querySelectorAll('[data-subtab]');
        const subtabContents = document.querySelectorAll('.tab-content .tab-content');
        const orderModal = document.getElementById('orderModal');
        const stockModal = document.getElementById('stockModal');
        const billModal = document.getElementById('billModal');
        const creditPaymentModal = document.getElementById('creditPaymentModal');
        const customerModal = document.getElementById('customerModal');
        const creditCustomerModal = document.getElementById('creditCustomerModal');
        const notificationContainer = document.getElementById('notificationContainer');
        const currentUserInfo = document.getElementById('currentUserInfo');
        const welcomeOverlay = document.getElementById('welcomeOverlay');

        // POS elements
        const posProducts = document.getElementById('posProducts');
        const tableGrid = document.getElementById('tableGrid');
        const cartItems = document.getElementById('cartItems');
        const cartTotal = document.getElementById('cartTotal');
        const clearCartBtn = document.getElementById('clearCartBtn');
        const holdOrderBtn = document.getElementById('holdOrderBtn');
        const completeOrderBtn = document.getElementById('completeOrderBtn');
        const heldOrdersTable = document.getElementById('heldOrdersTable').querySelector('tbody');
        const printBillBtn = document.getElementById('printBillBtn');
        const closeBillModal = document.getElementById('closeBillModal');
        const closeBillModalBtn = document.getElementById('closeBillModalBtn');
        const customerSearch = document.getElementById('customerSearch');
        const customerSearchResults = document.getElementById('customerSearchResults');
        const selectedCustomerDiv = document.getElementById('selectedCustomer');
        const customerInfoDiv = document.getElementById('customerInfo');
        const creditLimitInfoDiv = document.getElementById('creditLimitInfo');
        const clearCustomerBtn = document.getElementById('clearCustomerBtn');
        const creditOrderBtn = document.getElementById('creditOrderBtn');
        const customerTypeButtons = document.querySelectorAll('.customer-type-btn');
        const regularCustomerForm = document.getElementById('regularCustomerForm');
        const creditCustomerSection = document.getElementById('creditCustomerSection');
        const customerNameInput = document.getElementById('customerNameInput');
        const customerPhoneInput = document.getElementById('customerPhoneInput');

        // Settings elements
        const tableCountInput = document.getElementById('tableCount');
        const invoiceNameInput = document.getElementById('invoiceName');
        const defaultCreditDaysInput = document.getElementById('defaultCreditDays');
        const overduePenaltyInput = document.getElementById('overduePenalty');
        const saveTableSettingsBtn = document.getElementById('saveTableSettings');
        const saveInvoiceSettingsBtn = document.getElementById('saveInvoiceSettings');
        const saveCreditSettingsBtn = document.getElementById('saveCreditSettings');

        // Expenses elements
        const addExpenseForm = document.getElementById('addExpenseForm');
        const expensesTable = document.getElementById('expensesTable').querySelector('tbody');
        const expensesTableFooter = document.getElementById('expensesTableFooter');
        const filterExpensesBtn = document.getElementById('filterExpensesBtn');
        const exportExpensesExcelBtn = document.getElementById('exportExpensesExcelBtn');
        const exportExpensesPdfBtn = document.getElementById('exportExpensesPdfBtn');

        // Credit elements
        const addCustomerForm = document.getElementById('addCustomerForm');
        const customersTable = document.getElementById('customersTable').querySelector('tbody');
        const creditTable = document.getElementById('creditTable').querySelector('tbody');
        const filterCustomersBtn = document.getElementById('filterCustomersBtn');
        const filterCreditBtn = document.getElementById('filterCreditBtn');
        const addPaymentBtn = document.getElementById('addPaymentBtn');
        const savePaymentBtn = document.getElementById('savePaymentBtn');

        // Reports elements
        const generateReportBtn = document.getElementById('generateReportBtn');
        const salesReportTable = document.getElementById('salesReportTable').querySelector('tbody');
        const expensesReportTable = document.getElementById('expensesReportTable').querySelector('tbody');
        const creditReportTable = document.getElementById('creditReportTable').querySelector('tbody');
        const salesReportTotal = document.getElementById('salesReportTotal');
        const expensesReportTotal = document.getElementById('expensesReportTotal');
        const balanceSheetRevenue = document.getElementById('balanceSheetRevenue');
        const balanceSheetExpenses = document.getElementById('balanceSheetExpenses');
        const balanceSheetNetProfit = document.getElementById('balanceSheetNetProfit');
        const creditReportTotal = document.getElementById('creditReportTotal');
        const creditReportPaid = document.getElementById('creditReportPaid');
        const creditReportDue = document.getElementById('creditReportDue');
        const creditReportOverdue = document.getElementById('creditReportOverdue');

        // Dashboard elements
        const dashboardFilterBtn = document.getElementById('dashboardFilterBtn');
        const dashboardTotalSales = document.getElementById('dashboardTotalSales');
        const dashboardTotalExpenses = document.getElementById('dashboardTotalExpenses');
        const dashboardNetProfit = document.getElementById('dashboardNetProfit');
        const dashboardOrderCount = document.getElementById('dashboardOrderCount');
        const dashboardCreditSales = document.getElementById('dashboardCreditSales');
        const totalCreditElement = document.getElementById('totalCredit');
        const pendingCreditElement = document.getElementById('pendingCredit');

        // Initialize the admin panel
        function initAdmin() {
            // Check if user is already logged in
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                userAccess = currentUser.access || [];
                showAdminPanel();
                updateUserInterface();
                loadDashboardData();
                loadProducts();
                loadCategories();
                loadOrders();
                loadTables();
                loadHeldOrders();
                loadStock();
                loadExpenses();
                loadCreditCustomers();
                loadCreditTransactions();
                loadSettings();
                updateDashboardSummary();
                
                // Set up real-time listeners
                setupRealtimeListeners();
            } else {
                showLoginScreen();
            }

            // Owner password submission
            submitOwnerPassword.addEventListener('click', () => {
                const password = document.getElementById('ownerPassword').value;
                if (password === '8555') {
                    ownerAuthScreen.style.display = 'none';
                    ownerModal.style.display = 'block';
                    loadUsers();
                    loadSettings();
                } else {
                    showNotification('Invalid owner password', 'error');
                }
            });

            // Login button event
            loginBtn.addEventListener('click', handleLogin);

            // Owner button event
            ownerBtn.addEventListener('click', () => {
                loginScreen.style.display = 'none';
                ownerAuthScreen.style.display = 'flex';
            });

            // Close owner modal
            document.getElementById('closeOwnerModal').addEventListener('click', () => {
                ownerModal.style.display = 'none';
                showLoginScreen();
            });

            // Create user form
            createUserForm.addEventListener('submit', createUser);

            // Settings buttons
            saveTableSettingsBtn.addEventListener('click', saveTableSettings);
            saveInvoiceSettingsBtn.addEventListener('click', saveInvoiceSettings);
            saveCreditSettingsBtn.addEventListener('click', saveCreditSettings);

            // Logout button event
            logoutBtn.addEventListener('click', handleLogout);

            // Sidebar navigation
            sidebarLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const tab = link.dataset.tab;
                    
                    // Check if user has access to this tab
                    if (!userAccess.includes(tab) && tab !== 'dashboard') {
                        showNotification('You do not have access to this section', 'error');
                        return;
                    }
                    
                    switchTab(tab);
                    
                    // Update active state
                    sidebarLinks.forEach(l => l.classList.remove('active'));
                    link.classList.add('active');
                });
            });

            // Sub-tab navigation
            subtabTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const subtab = tab.dataset.subtab;
                    switchSubTab(subtab);
                    
                    // Update active state
                    subtabTabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                });
            });

            // Modal close buttons
            document.getElementById('closeOrderModal').addEventListener('click', () => orderModal.style.display = 'none');
            document.getElementById('closeOrderModalBtn').addEventListener('click', () => orderModal.style.display = 'none');
            document.getElementById('closeStockModal').addEventListener('click', () => stockModal.style.display = 'none');
            document.getElementById('closeStockModalBtn').addEventListener('click', () => stockModal.style.display = 'none');
            closeBillModal.addEventListener('click', () => billModal.style.display = 'none');
            closeBillModalBtn.addEventListener('click', () => billModal.style.display = 'none');
            document.getElementById('closeCreditPaymentModal').addEventListener('click', () => creditPaymentModal.style.display = 'none');
            document.getElementById('closeCreditPaymentModalBtn').addEventListener('click', () => creditPaymentModal.style.display = 'none');
            document.getElementById('closeCustomerModal').addEventListener('click', () => customerModal.style.display = 'none');
            document.getElementById('closeCustomerModalBtn').addEventListener('click', () => customerModal.style.display = 'none');
            document.getElementById('closeCreditCustomerModal').addEventListener('click', () => creditCustomerModal.style.display = 'none');
            document.getElementById('closeCreditCustomerModalBtn').addEventListener('click', () => creditCustomerModal.style.display = 'none');

            // Close modals when clicking outside
            window.addEventListener('click', (e) => {
                if (e.target === orderModal) orderModal.style.display = 'none';
                if (e.target === ownerModal) ownerModal.style.display = 'none';
                if (e.target === stockModal) stockModal.style.display = 'none';
                if (e.target === billModal) billModal.style.display = 'none';
                if (e.target === creditPaymentModal) creditPaymentModal.style.display = 'none';
                if (e.target === customerModal) customerModal.style.display = 'none';
                if (e.target === creditCustomerModal) creditCustomerModal.style.display = 'none';
            });

            // Delete buttons
            document.getElementById('deleteOrderBtn').addEventListener('click', deleteOrder);

            // Credit button
            creditOrderBtn.addEventListener('click', sendOrderToCredit);

            // Payment button
            addPaymentBtn.addEventListener('click', showPaymentForm);
            savePaymentBtn.addEventListener('click', savePayment);

            // Filter buttons
            document.getElementById('filterOrdersBtn').addEventListener('click', loadOrders);
            document.getElementById('filterStockBtn').addEventListener('click', loadStock);
            filterExpensesBtn.addEventListener('click', loadExpenses);
            filterCustomersBtn.addEventListener('click', loadCreditCustomers);
            filterCreditBtn.addEventListener('click', loadCreditTransactions);
            generateReportBtn.addEventListener('click', generateReports);
            dashboardFilterBtn.addEventListener('click', updateDashboardSummary);

            // Export buttons
            document.getElementById('exportOrdersExcelBtn').addEventListener('click', () => exportToExcel('orders'));
            document.getElementById('exportOrdersPdfBtn').addEventListener('click', () => exportToPdf('orders'));
            exportExpensesExcelBtn.addEventListener('click', () => exportToExcel('expenses'));
            exportExpensesPdfBtn.addEventListener('click', () => exportToPdf('expenses'));
            document.getElementById('exportSalesReportExcelBtn').addEventListener('click', () => exportToExcel('salesReport'));
            document.getElementById('exportSalesReportPdfBtn').addEventListener('click', () => exportToPdf('salesReport'));
            document.getElementById('exportExpensesReportExcelBtn').addEventListener('click', () => exportToExcel('expensesReport'));
            document.getElementById('exportExpensesReportPdfBtn').addEventListener('click', () => exportToPdf('expensesReport'));
            document.getElementById('exportCreditReportExcelBtn').addEventListener('click', () => exportToExcel('creditReport'));
            document.getElementById('exportCreditReportPdfBtn').addEventListener('click', () => exportToPdf('creditReport'));
            document.getElementById('exportBalanceSheetExcelBtn').addEventListener('click', () => exportToExcel('balanceSheet'));
            document.getElementById('exportBalanceSheetPdfBtn').addEventListener('click', () => exportToPdf('balanceSheet'));

            // Form submissions
            document.getElementById('addProductForm').addEventListener('submit', addProduct);
            document.getElementById('addCategoryForm').addEventListener('submit', addCategory);
            addExpenseForm.addEventListener('submit', addExpense);
            addCustomerForm.addEventListener('submit', addCustomer);

            // POS buttons
            clearCartBtn.addEventListener('click', clearCart);
            holdOrderBtn.addEventListener('click', holdOrder);
            completeOrderBtn.addEventListener('click', completeOrder);
            printBillBtn.addEventListener('click', printBill);

            // Stock management
            document.getElementById('saveStockBtn').addEventListener('click', saveStockChanges);

            // Customer search functionality
            customerSearch.addEventListener('input', handleCustomerSearch);
            clearCustomerBtn.addEventListener('click', clearSelectedCustomer);

            // Customer type selection
            customerTypeButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const type = btn.dataset.customerType;
                    selectCustomerType(type);
                });
            });
        }

        // Show login screen
        function showLoginScreen() {
            ownerAuthScreen.style.display = 'none';
            loginScreen.style.display = 'flex';
            adminPanel.style.display = 'none';
            usernameInput.value = '';
            passwordInput.value = '';
        }

        // Show admin panel
        function showAdminPanel() {
            ownerAuthScreen.style.display = 'none';
            loginScreen.style.display = 'none';
            adminPanel.style.display = 'flex';
            welcomeOverlay.style.display = 'none';
        }

        // Handle login
        function handleLogin() {
            const username = usernameInput.value.trim();
            const password = passwordInput.value.trim();

            if (!username || !password) {
                showNotification('Please enter username and password', 'error');
                return;
            }

            // Show welcome animation
            welcomeOverlay.style.display = 'flex';
            
            // After animation completes, proceed with login
            setTimeout(() => {
                database.ref('adminUsers').once('value').then(snapshot => {
                    const users = snapshot.val();
                    let authenticated = false;
                    
                    if (users) {
                        Object.entries(users).forEach(([id, user]) => {
                            if (user.username === username && user.password === password) {
                                authenticated = true;
                                currentUser = { id, ...user };
                                userAccess = user.access || [];
                                
                                // Save to localStorage
                                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                                
                                showAdminPanel();
                                updateUserInterface();
                                loadDashboardData();
                                loadProducts();
                                loadCategories();
                                loadOrders();
                                loadTables();
                                loadHeldOrders();
                                loadStock();
                                loadExpenses();
                                loadCreditCustomers();
                                loadCreditTransactions();
                                loadSettings();
                                updateDashboardSummary();
                                
                                // Set up real-time listeners
                                setupRealtimeListeners();
                            }
                        });
                    }
                    
                    if (!authenticated) {
                        showNotification('Invalid username or password', 'error');
                        welcomeOverlay.style.display = 'none';
                    }
                }).catch(error => {
                    showNotification('Error during login: ' + error.message, 'error');
                    welcomeOverlay.style.display = 'none';
                });
            }, 3500); // Wait for animation to complete
        }

        // Select customer type (regular or credit)
        function selectCustomerType(type) {
            customerType = type;
            
            // Update active button
            customerTypeButtons.forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.customerType === type) {
                    btn.classList.add('active');
                }
            });
            
            // Show appropriate form
            if (type === 'regular') {
                regularCustomerForm.style.display = 'block';
                creditCustomerSection.style.display = 'none';
                clearSelectedCustomer();
            } else {
                regularCustomerForm.style.display = 'none';
                creditCustomerSection.style.display = 'block';
                customerNameInput.value = '';
                customerPhoneInput.value = '';
            }
        }

        // Create new user
        function createUser(e) {
            e.preventDefault();
            
            const username = document.getElementById('newUsername').value;
            const password = document.getElementById('newPassword').value;
            const role = document.getElementById('userRole').value;
            
            // Get access controls
            const access = [];
            document.querySelectorAll('input[name="access"]:checked').forEach(checkbox => {
                access.push(checkbox.value);
            });
            
            const newUser = {
                username,
                password,
                role,
                access,
                createdAt: new Date().toISOString()
            };
            
            database.ref('adminUsers').push(newUser)
                .then(() => {
                    showNotification('User created successfully!');
                    createUserForm.reset();
                    loadUsers();
                })
                .catch(error => {
                    showNotification('Error creating user: ' + error.message, 'error');
                });
        }

        // Load users for owner modal
        function loadUsers() {
            database.ref('adminUsers').once('value').then(snapshot => {
                const users = snapshot.val();
                const userListContainer = document.getElementById('userListContainer');
                userListContainer.innerHTML = '';
                
                if (users) {
                    Object.entries(users).forEach(([id, user]) => {
                        const userCard = document.createElement('div');
                        userCard.className = 'user-card';
                        userCard.innerHTML = `
                            <div class="user-info">
                                <h3>${user.username}</h3>
                                <p>Role: ${user.role} | Access: ${user.access.join(', ')}</p>
                                <p>Created: ${new Date(user.createdAt).toLocaleDateString()}</p>
                            </div>
                            <div class="action-buttons">
                                <button class="btn btn-danger delete-user" data-id="${id}">Delete</button>
                            </div>
                        `;
                        userListContainer.appendChild(userCard);
                    });
                    
                    // Add event listeners to delete buttons
                    document.querySelectorAll('.delete-user').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const userId = btn.dataset.id;
                            deleteUser(userId);
                        });
                    });
                }
            });
        }

        // Load settings
        function loadSettings() {
            database.ref('settings').once('value').then(snapshot => {
                const settings = snapshot.val();
                
                if (settings) {
                    // Load table count
                    if (settings.tableCount) {
                        tablesCount = settings.tableCount;
                        tableCountInput.value = tablesCount;
                    }
                    
                    // Load invoice name
                    if (settings.invoiceName) {
                        invoiceName = settings.invoiceName;
                        invoiceNameInput.value = invoiceName;
                    }
                    
                    // Load credit settings
                    if (settings.defaultCreditDays) {
                        defaultCreditDays = settings.defaultCreditDays;
                        defaultCreditDaysInput.value = defaultCreditDays;
                    }
                    
                    // Load overdue penalty
                    if (settings.overduePenalty) {
                        overduePenalty = settings.overduePenalty;
                        overduePenaltyInput.value = overduePenalty;
                    }
                }
            });
        }

        // Save table settings
        function saveTableSettings() {
            const newTableCount = parseInt(tableCountInput.value);
            
            if (isNaN(newTableCount) || newTableCount < 1) {
                showNotification('Please enter a valid number of tables', 'error');
                return;
            }
            
            tablesCount = newTableCount;
            
            database.ref('settings/tableCount').set(tablesCount)
                .then(() => {
                    showNotification('Table settings saved successfully!');
                    loadTables();
                })
                .catch(error => {
                    showNotification('Error saving table settings: ' + error.message, 'error');
                });
        }

        // Save invoice settings
        function saveInvoiceSettings() {
            const newInvoiceName = invoiceNameInput.value.trim();
            
            if (!newInvoiceName) {
                showNotification('Please enter an invoice name', 'error');
                return;
            }
            
            invoiceName = newInvoiceName;
            
            database.ref('settings/invoiceName').set(invoiceName)
                .then(() => {
                    showNotification('Invoice settings saved successfully!');
                })
                .catch(error => {
                    showNotification('Error saving invoice settings: ' + error.message, 'error');
                });
        }

        // Save credit settings
        function saveCreditSettings() {
            const newDefaultCreditDays = parseInt(defaultCreditDaysInput.value);
            const newOverduePenalty = parseFloat(overduePenaltyInput.value);
            
            if (isNaN(newDefaultCreditDays) || newDefaultCreditDays < 1) {
                showNotification('Please enter valid credit days', 'error');
                return;
            }
            
            if (isNaN(newOverduePenalty) || newOverduePenalty < 0) {
                showNotification('Please enter valid overdue penalty percentage', 'error');
                return;
            }
            
            defaultCreditDays = newDefaultCreditDays;
            overduePenalty = newOverduePenalty;
            
            database.ref('settings').update({
                defaultCreditDays: defaultCreditDays,
                overduePenalty: overduePenalty
            }).then(() => {
                showNotification('Credit settings saved successfully!');
            }).catch(error => {
                showNotification('Error saving credit settings: ' + error.message, 'error');
            });
        }

        // Delete user
        function deleteUser(userId) {
            if (confirm('Are you sure you want to delete this user?')) {
                database.ref('adminUsers/' + userId).remove()
                    .then(() => {
                        showNotification('User deleted successfully!');
                        loadUsers();
                    })
                    .catch(error => {
                        showNotification('Error deleting user: ' + error.message, 'error');
                    });
            }
        }

        // Update user interface based on access
        function updateUserInterface() {
            // Update user info in header
            currentUserInfo.textContent = `Logged in as: ${currentUser.username} (${currentUser.role})`;
            
            // Hide sidebar items based on access
            sidebarLinks.forEach(link => {
                const tab = link.dataset.tab;
                if (tab !== 'dashboard' && !userAccess.includes(tab)) {
                    link.style.display = 'none';
                } else {
                    link.style.display = 'flex';
                }
            });
        }

        // Handle logout
        function handleLogout() {
            localStorage.removeItem('currentUser');
            currentUser = null;
            userAccess = [];
            showLoginScreen();
        }

        // Switch between main tabs
        function switchTab(tab) {
            tabContents.forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tab).classList.add('active');
            
            // Update header title
            document.querySelector('.header h1').textContent = getTabTitle(tab);
            
            // Load specific data for certain tabs
            if (tab === 'pos') {
                loadProductsForPOS();
                loadHeldOrders();
            } else if (tab === 'stock') {
                loadStock();
            } else if (tab === 'expenses') {
                loadExpenses();
            } else if (tab === 'credit') {
                loadCreditCustomers();
                loadCreditTransactions();
            } else if (tab === 'reports') {
                generateReports();
            }
        }

        // Switch between sub-tabs
        function switchSubTab(subtab) {
            subtabContents.forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(subtab).classList.add('active');
        }

        // Get tab title
        function getTabTitle(tab) {
            const titles = {
                'dashboard': 'Admin Dashboard',
                'pos': 'POS System',
                'products': 'Product Management',
                'categories': 'Category Management',
                'orders': 'Order Management',
                'stock': 'Stock Management',
                'expenses': 'Expenses Management',
                'credit': 'Credit Management',
                'reports': 'Financial Reports'
            };
            return titles[tab] || 'Admin Dashboard';
        }

        // Set up real-time listeners for new orders
        function setupRealtimeListeners() {
            // Listen for new orders (only show notification for new orders)
            database.ref('orders').orderByChild('createdAt').on('child_added', (snapshot) => {
                const order = snapshot.val();
                const orderId = snapshot.key;
                
                // Only show notification if this is a new order that hasn't been notified yet
                if (!notifiedOrders[orderId] && order.status === 'pending') {
                    notifiedOrders[orderId] = true;
                    showNotification(`New order received: ${order.orderNumber} from ${order.shippingInfo?.name}`, 'success');
                }
                
                loadDashboardData();
                loadOrders();
            });
        }

        // Show notification
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type === 'error' ? 'notification-error' : type === 'warning' ? 'notification-warning' : ''}`;
            notification.innerHTML = `
                <i class="fas ${type === 'error' ? 'fa-exclamation-circle' : type === 'warning' ? 'fa-exclamation-triangle' : 'fa-check-circle'}"></i>
                <span>${message}</span>
                <button class="close-notification"><i class="fas fa-times"></i></button>
            `;
            
            notificationContainer.appendChild(notification);
            
            // Add event listener to close button
            notification.querySelector('.close-notification').addEventListener('click', () => {
                notification.remove();
            });
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }

        // Load dashboard data
        function loadDashboardData() {
            // Load orders count
            database.ref('orders').once('value').then(snapshot => {
                const orders = snapshot.val();
                const ordersCount = orders ? Object.keys(orders).length : 0;
                document.getElementById('totalOrders').textContent = ordersCount;
                
                // Calculate total revenue and count completed orders
                let totalRevenue = 0;
                let completedOrders = 0;
                let creditSales = 0;
                let pendingCredit = 0;
                
                if (orders) {
                    Object.values(orders).forEach(order => {
                        if (order.status === 'completed' || order.status === 'delivered') {
                            totalRevenue += order.total || 0;
                            completedOrders++;
                            
                            // Check if it's a credit order
                            if (order.paymentMethod === 'credit') {
                                creditSales += order.total || 0;
                                
                                // Check if it's still pending
                                if (order.creditStatus && order.creditStatus !== 'paid') {
                                    pendingCredit += order.total || 0;
                                }
                            }
                        }
                    });
                }
                
                // Load POS orders
                database.ref('posOrders').once('value').then(posSnapshot => {
                    const posOrders = posSnapshot.val();
                    if (posOrders) {
                        Object.values(posOrders).forEach(order => {
                            if (order.status === 'completed') {
                                totalRevenue += order.total || 0;
                                completedOrders++;
                                
                                // Check if it's a credit order
                                if (order.paymentMethod === 'credit') {
                                    creditSales += order.total || 0;
                                    
                                    // Check if it's still pending
                                    if (order.creditStatus && order.creditStatus !== 'paid') {
                                        pendingCredit += order.total || 0;
                                    }
                                }
                            }
                        });
                    }
                    
                    // Load expenses
                    database.ref('expenses').once('value').then(expensesSnapshot => {
                        const expenses = expensesSnapshot.val();
                        let totalExpenses = 0;
                        
                        if (expenses) {
                            Object.values(expenses).forEach(expense => {
                                totalExpenses += expense.amount || 0;
                            });
                        }
                        
                        const netProfit = totalRevenue - totalExpenses;
                        
                        document.getElementById('totalRevenue').textContent = `Rf ${totalRevenue.toFixed(2)}`;
                        document.getElementById('completedOrders').textContent = completedOrders;
                        document.getElementById('totalExpenses').textContent = `Rf ${totalExpenses.toFixed(2)}`;
                        document.getElementById('netProfit').textContent = `Rf ${netProfit.toFixed(2)}`;
                        document.getElementById('totalCredit').textContent = `Rf ${creditSales.toFixed(2)}`;
                        document.getElementById('pendingCredit').textContent = `Rf ${pendingCredit.toFixed(2)}`;
                    });
                });
                
                // Load held orders count
                database.ref('heldOrders').once('value').then(heldSnapshot => {
                    const heldOrders = heldSnapshot.val();
                    const heldOrdersCount = heldOrders ? Object.keys(heldOrders).length : 0;
                    document.getElementById('heldOrdersCount').textContent = heldOrdersCount;
                });
            });
        }

        // Update dashboard summary with date filters
        function updateDashboardSummary() {
            const dateFrom = document.getElementById('dashboardDateFrom').value;
            const dateTo = document.getElementById('dashboardDateTo').value;
            
            let totalSales = 0;
            let totalExpenses = 0;
            let orderCount = 0;
            let creditSales = 0;
            
            // Calculate sales from orders
            database.ref('orders').once('value').then(ordersSnapshot => {
                const orders = ordersSnapshot.val();
                if (orders) {
                    Object.values(orders).forEach(order => {
                        if ((!dateFrom || order.date >= dateFrom) && (!dateTo || order.date <= dateTo)) {
                            if (order.status === 'completed' || order.status === 'delivered') {
                                totalSales += order.total || 0;
                                orderCount++;
                                
                                if (order.paymentMethod === 'credit') {
                                    creditSales += order.total || 0;
                                }
                            }
                        }
                    });
                }
                
                // Calculate sales from POS orders
                database.ref('posOrders').once('value').then(posSnapshot => {
                    const posOrders = posSnapshot.val();
                    if (posOrders) {
                        Object.values(posOrders).forEach(order => {
                            const orderDate = new Date(order.createdAt).toISOString().split('T')[0];
                            if ((!dateFrom || orderDate >= dateFrom) && (!dateTo || orderDate <= dateTo)) {
                                if (order.status === 'completed') {
                                    totalSales += order.total || 0;
                                    orderCount++;
                                    
                                    if (order.paymentMethod === 'credit') {
                                        creditSales += order.total || 0;
                                    }
                                }
                            }
                        });
                    }
                    
                    // Calculate expenses
                    database.ref('expenses').once('value').then(expensesSnapshot => {
                        const expenses = expensesSnapshot.val();
                        if (expenses) {
                            Object.values(expenses).forEach(expense => {
                                if ((!dateFrom || expense.date >= dateFrom) && (!dateTo || expense.date <= dateTo)) {
                                    totalExpenses += expense.amount || 0;
                                }
                            });
                        }
                        
                        const netProfit = totalSales - totalExpenses;
                        
                        // Update dashboard summary
                        dashboardTotalSales.textContent = `Rf ${totalSales.toFixed(2)}`;
                        dashboardTotalExpenses.textContent = `Rf ${totalExpenses.toFixed(2)}`;
                        dashboardNetProfit.textContent = `Rf ${netProfit.toFixed(2)}`;
                        dashboardOrderCount.textContent = orderCount;
                        dashboardCreditSales.textContent = `Rf ${creditSales.toFixed(2)}`;
                    });
                });
            });
        }

        // Generate reports based on date filters
        function generateReports() {
            const dateFrom = document.getElementById('reportDateFrom').value;
            const dateTo = document.getElementById('reportDateTo').value;
            
            generateSalesReport(dateFrom, dateTo);
            generateExpensesReport(dateFrom, dateTo);
            generateCreditReport(dateFrom, dateTo);
            generateBalanceSheet(dateFrom, dateTo);
        }

        // Generate sales report
        function generateSalesReport(dateFrom, dateTo) {
            salesReportTable.innerHTML = '';
            let totalSales = 0;
            
            // Process regular orders
            database.ref('orders').once('value').then(ordersSnapshot => {
                const orders = ordersSnapshot.val();
                if (orders) {
                    Object.entries(orders).forEach(([id, order]) => {
                        if ((!dateFrom || order.date >= dateFrom) && (!dateTo || order.date <= dateTo)) {
                            if (order.status === 'completed' || order.status === 'delivered') {
                                totalSales += order.total || 0;
                                
                                const row = document.createElement('tr');
                                row.innerHTML = `
                                    <td>${order.date || 'N/A'}</td>
                                    <td>${order.orderNumber || id}</td>
                                    <td>${order.shippingInfo?.name || 'N/A'}</td>
                                    <td>Rf ${(order.total || 0).toFixed(2)}</td>
                                    <td>${order.paymentMethod || 'N/A'}</td>
                                `;
                                salesReportTable.appendChild(row);
                            }
                        }
                    });
                }
                
                // Process POS orders
                database.ref('posOrders').once('value').then(posSnapshot => {
                    const posOrders = posSnapshot.val();
                    if (posOrders) {
                        Object.entries(posOrders).forEach(([id, order]) => {
                            const orderDate = new Date(order.createdAt).toISOString().split('T')[0];
                            if ((!dateFrom || orderDate >= dateFrom) && (!dateTo || orderDate <= dateTo)) {
                                if (order.status === 'completed') {
                                    totalSales += order.total || 0;
                                    
                                    const row = document.createElement('tr');
                                    row.innerHTML = `
                                        <td>${orderDate}</td>
                                        <td>${order.orderNumber || id}</td>
                                        <td>Table ${order.table || 'N/A'}</td>
                                        <td>Rf ${(order.total || 0).toFixed(2)}</td>
                                        <td>${order.paymentMethod || 'N/A'}</td>
                                    `;
                                    salesReportTable.appendChild(row);
                                }
                            }
                        });
                    }
                    
                    salesReportTotal.textContent = `Rf ${totalSales.toFixed(2)}`;
                });
            });
        }

        // Generate expenses report
        function generateExpensesReport(dateFrom, dateTo) {
            expensesReportTable.innerHTML = '';
            let totalExpenses = 0;
            
            database.ref('expenses').once('value').then(snapshot => {
                const expenses = snapshot.val();
                if (expenses) {
                    Object.entries(expenses).forEach(([id, expense]) => {
                        if ((!dateFrom || expense.date >= dateFrom) && (!dateTo || expense.date <= dateTo)) {
                            totalExpenses += expense.amount || 0;
                            
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${expense.date}</td>
                                <td>${expense.supplier}</td>
                                <td>${expense.purpose}</td>
                                <td>Rf ${expense.amount?.toFixed(2) || '0.00'}</td>
                                <td>${expense.invoiceNumber}</td>
                            `;
                            expensesReportTable.appendChild(row);
                        }
                    });
                }
                
                expensesReportTotal.textContent = `Rf ${totalExpenses.toFixed(2)}`;
            });
        }

        // Generate credit report
        function generateCreditReport(dateFrom, dateTo) {
            creditReportTable.innerHTML = '';
            let totalCredit = 0;
            let totalPaid = 0;
            let totalDue = 0;
            let totalOverdue = 0;
            
            database.ref('creditTransactions').once('value').then(snapshot => {
                const transactions = snapshot.val();
                if (transactions) {
                    // Group by customer
                    const customerTotals = {};
                    
                    Object.values(transactions).forEach(transaction => {
                        const transactionDate = new Date(transaction.createdAt).toISOString().split('T')[0];
                        if ((!dateFrom || transactionDate >= dateFrom) && (!dateTo || transactionDate <= dateTo)) {
                            const customerId = transaction.customerId;
                            
                            if (!customerTotals[customerId]) {
                                customerTotals[customerId] = {
                                    customerName: transaction.customerName,
                                    total: 0,
                                    paid: 0,
                                    due: 0,
                                    overdue: 0
                                };
                            }
                            
                            customerTotals[customerId].total += transaction.amount || 0;
                            
                            if (transaction.status === 'paid') {
                                customerTotals[customerId].paid += transaction.amount || 0;
                            } else {
                                customerTotals[customerId].due += transaction.amount || 0;
                                
                                // Check if overdue
                                const dueDate = new Date(transaction.dueDate);
                                if (dueDate < new Date()) {
                                    customerTotals[customerId].overdue += transaction.amount || 0;
                                }
                            }
                        }
                    });
                    
                    // Add rows for each customer
                    Object.values(customerTotals).forEach(customer => {
                        totalCredit += customer.total;
                        totalPaid += customer.paid;
                        totalDue += customer.due;
                        totalOverdue += customer.overdue;
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${customer.customerName}</td>
                            <td>Rf ${customer.total.toFixed(2)}</td>
                            <td>Rf ${customer.paid.toFixed(2)}</td>
                            <td>Rf ${customer.due.toFixed(2)}</td>
                            <td>Rf ${customer.overdue.toFixed(2)}</td>
                        `;
                        creditReportTable.appendChild(row);
                    });
                }
                
                // Update totals
                creditReportTotal.textContent = `Rf ${totalCredit.toFixed(2)}`;
                creditReportPaid.textContent = `Rf ${totalPaid.toFixed(2)}`;
                creditReportDue.textContent = `Rf ${totalDue.toFixed(2)}`;
                creditReportOverdue.textContent = `Rf ${totalOverdue.toFixed(2)}`;
            });
        }

        // Generate balance sheet
        function generateBalanceSheet(dateFrom, dateTo) {
            let totalRevenue = 0;
            let totalExpenses = 0;
            let totalCredit = 0;
            let pendingCredit = 0;
            
            // Calculate revenue from orders
            database.ref('orders').once('value').then(ordersSnapshot => {
                const orders = ordersSnapshot.val();
                if (orders) {
                    Object.values(orders).forEach(order => {
                        if ((!dateFrom || order.date >= dateFrom) && (!dateTo || order.date <= dateTo)) {
                            if (order.status === 'completed' || order.status === 'delivered') {
                                totalRevenue += order.total || 0;
                                
                                if (order.paymentMethod === 'credit') {
                                    totalCredit += order.total || 0;
                                    
                                    if (order.creditStatus && order.creditStatus !== 'paid') {
                                        pendingCredit += order.total || 0;
                                    }
                                }
                            }
                        }
                    });
                }
                
                // Calculate revenue from POS orders
                database.ref('posOrders').once('value').then(posSnapshot => {
                    const posOrders = posSnapshot.val();
                    if (posOrders) {
                        Object.values(posOrders).forEach(order => {
                            const orderDate = new Date(order.createdAt).toISOString().split('T')[0];
                            if ((!dateFrom || orderDate >= dateFrom) && (!dateTo || orderDate <= dateTo)) {
                                if (order.status === 'completed') {
                                    totalRevenue += order.total || 0;
                                    
                                    if (order.paymentMethod === 'credit') {
                                        totalCredit += order.total || 0;
                                        
                                        if (order.creditStatus && order.creditStatus !== 'paid') {
                                            pendingCredit += order.total || 0;
                                        }
                                    }
                                }
                            }
                        });
                    }
                    
                    // Calculate expenses
                    database.ref('expenses').once('value').then(expensesSnapshot => {
                        const expenses = expensesSnapshot.val();
                        if (expenses) {
                            Object.values(expenses).forEach(expense => {
                                if ((!dateFrom || expense.date >= dateFrom) && (!dateTo || expense.date <= dateTo)) {
                                    totalExpenses += expense.amount || 0;
                                }
                            });
                        }
                        
                        const netProfit = totalRevenue - totalExpenses;
                        
                        // Update balance sheet
                        balanceSheetRevenue.textContent = `Rf ${totalRevenue.toFixed(2)}`;
                        balanceSheetExpenses.textContent = `Rf ${totalExpenses.toFixed(2)}`;
                        balanceSheetCredit.textContent = `Rf ${totalCredit.toFixed(2)}`;
                        balanceSheetPending.textContent = `Rf ${pendingCredit.toFixed(2)}`;
                        balanceSheetNetProfit.textContent = `Rf ${netProfit.toFixed(2)}`;
                    });
                });
            });
        }

        // Load products for POS with category filtering
        function loadProductsForPOS() {
            if (!userAccess.includes('pos')) return;
            
            database.ref('products').once('value').then(snapshot => {
                const products = snapshot.val();
                posProducts.innerHTML = '';
                
                if (products) {
                    Object.entries(products).forEach(([id, product]) => {
                        // Only show products with stock > 0 and matching selected category
                        if (product.stock > 0 && (selectedCategory === 'all' || product.category === selectedCategory)) {
                            const productCard = document.createElement('div');
                            productCard.className = 'pos-product-card';
                            productCard.innerHTML = `
                                <img src="${product.image}" alt="${product.name}">
                                <h3 class="product-name-dhivehi">${product.name}</h3>
                                <p>Rf ${product.price?.toFixed(2) || '0.00'}</p>
                                ${product.stock < 10 ? `<div class="stock-info stock-low">Low stock: ${product.stock}</div>` : ''}
                            `;
                            productCard.addEventListener('click', () => {
                                addToCart(id, product);
                            });
                            posProducts.appendChild(productCard);
                        }
                    });
                }
            });
        }

        // Load categories for POS filtering
        function loadCategoriesForPOS() {
            database.ref('categories').once('value').then(snapshot => {
                const categories = snapshot.val();
                categoryButtons.innerHTML = '<button class="category-btn active" data-category="all">All</button>';
                
                if (categories) {
                    Object.values(categories).forEach(category => {
                        const categoryBtn = document.createElement('button');
                        categoryBtn.className = 'category-btn';
                        categoryBtn.innerHTML = `<span class="category-name-dhivehi">${category}</span>`;
                        categoryBtn.dataset.category = category;
                        categoryBtn.addEventListener('click', () => {
                            // Update active category button
                            document.querySelectorAll('.category-btn').forEach(btn => {
                                btn.classList.remove('active');
                            });
                            categoryBtn.classList.add('active');
                            
                            // Filter products by category
                            selectedCategory = category;
                            loadProductsForPOS();
                        });
                        categoryButtons.appendChild(categoryBtn);
                    });
                }
                
                // Add event listener for "All" button
                document.querySelector('.category-btn[data-category="all"]').addEventListener('click', () => {
                    selectedCategory = 'all';
                    loadProductsForPOS();
                });
            });
        }

        // Load tables
        function loadTables() {
            database.ref('tables').once('value').then(snapshot => {
                const tables = snapshot.val();
                tableGrid.innerHTML = '';
                
                // Create table buttons
                for (let i = 1; i <= tablesCount; i++) {
                    const tableBtn = document.createElement('div');
                    tableBtn.className = 'table-btn';
                    tableBtn.textContent = i;
                    tableBtn.dataset.table = i;
                    
                    // Check if table is occupied
                    if (tables && tables[i] && tables[i].status === 'occupied') {
                        tableBtn.classList.add('occupied');
                    }
                    
                    tableBtn.addEventListener('click', () => {
                        selectTable(i);
                    });
                    
                    tableGrid.appendChild(tableBtn);
                }
            });
        }

        // Select table
        function selectTable(tableNumber) {
            // Deselect all tables
            document.querySelectorAll('.table-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Select the clicked table
            const tableBtn = document.querySelector(`.table-btn[data-table="${tableNumber}"]`);
            tableBtn.classList.add('active');
            
            currentTable = tableNumber;
            
            // Load any held order for this table
            loadHeldOrderForTable(tableNumber);
        }

        // Handle customer search
        function handleCustomerSearch() {
            const searchTerm = customerSearch.value.trim();
            
            if (searchTerm.length < 2) {
                customerSearchResults.style.display = 'none';
                return;
            }
            
            database.ref('creditCustomers').once('value').then(snapshot => {
                const customers = snapshot.val();
                customerSearchResults.innerHTML = '';
                
                if (customers) {
                    let found = false;
                    
                    Object.entries(customers).forEach(([id, customer]) => {
                        if (customer.name.toLowerCase().includes(searchTerm.toLowerCase()) || 
                            customer.contact.includes(searchTerm)) {
                            found = true;
                            
                            const result = document.createElement('div');
                            result.className = 'customer-search-result';
                            result.innerHTML = `
                                <div>${customer.name}</div>
                                <div>${customer.contact}</div>
                                <div class="credit-limit-info">Credit Limit: Rf ${customer.creditLimit?.toFixed(2) || '0.00'}</div>
                            `;
                            result.addEventListener('click', () => {
                                selectCustomer(id, customer);
                            });
                            
                            customerSearchResults.appendChild(result);
                        }
                    });
                    
                    if (found) {
                        customerSearchResults.style.display = 'block';
                    } else {
                        customerSearchResults.style.display = 'none';
                    }
                }
            });
        }

        // Select customer
        function selectCustomer(customerId, customer) {
            selectedCustomer = { id: customerId, ...customer };
            customerSearch.value = '';
            customerSearchResults.style.display = 'none';
            
            // Display selected customer
            customerInfoDiv.innerHTML = `
                <strong>${customer.name}</strong>
                <div>${customer.contact}</div>
            `;
            
            // Get outstanding balance
            getOutstandingBalance(customerId).then(balance => {
                const availableCredit = customer.creditLimit - balance;
                
                creditLimitInfoDiv.innerHTML = `
                    Credit Limit: Rf ${customer.creditLimit?.toFixed(2) || '0.00'} |
                    Outstanding: Rf ${balance.toFixed(2)} |
                    Available: Rf ${availableCredit.toFixed(2)}
                `;
                
                if (availableCredit <= 0) {
                    creditLimitInfoDiv.classList.add('credit-limit-warning');
                } else {
                    creditLimitInfoDiv.classList.remove('credit-limit-warning');
                }
            });
            
            selectedCustomerDiv.style.display = 'block';
        }

        // Clear selected customer
        function clearSelectedCustomer() {
            selectedCustomer = null;
            selectedCustomerDiv.style.display = 'none';
            customerInfoDiv.innerHTML = '';
            creditLimitInfoDiv.innerHTML = '';
            creditLimitInfoDiv.classList.remove('credit-limit-warning');
        }

        // Add to cart
        function addToCart(productId, product) {
            if (!currentTable) {
                showNotification('Please select a table first', 'error');
                return;
            }
            
            // Check if product already in cart
            const existingItem = cart.find(item => item.id === productId);
            
            if (existingItem) {
                // Check if we have enough stock
                if (existingItem.quantity >= product.stock) {
                    showNotification(`Not enough stock for ${product.name}. Only ${product.stock} available.`, 'error');
                    return;
                }
                existingItem.quantity++;
            } else {
                // Check if we have at least 1 in stock
                if (product.stock < 1) {
                    showNotification(`No stock available for ${product.name}`, 'error');
                    return;
                }
                cart.push({
                    id: productId,
                    name: product.name,
                    price: product.price,
                    quantity: 1,
                    maxStock: product.stock // Store max available stock for validation
                });
            }
            
            updateCart();
        }

        // Update cart display
        function updateCart() {
            cartItems.innerHTML = '';
            
            if (cart.length === 0) {
                cartItems.innerHTML = '<p class="empty-cart">No items added yet</p>';
                cartTotal.textContent = 'Total: Rf 0.00';
                return;
            }
            
            let total = 0;
            
            cart.forEach((item, index) => {
                const itemTotal = item.price * item.quantity;
                total += itemTotal;
                
                const cartItem = document.createElement('div');
                cartItem.className = 'cart-item';
                cartItem.innerHTML = `
                    <div class="cart-item-info">
                        <div class="product-name-dhivehi">${item.name}</div>
                        <div class="cart-item-quantity">
                            <button class="quantity-btn decrease-btn" data-index="${index}">-</button>
                            <span>${item.quantity}</span>
                            <button class="quantity-btn increase-btn" data-index="${index}">+</button>
                        </div>
                    </div>
                    <div class="cart-item-price">
                        Rf ${itemTotal.toFixed(2)}
                    </div>
                `;
                
                cartItems.appendChild(cartItem);
            });
            
            cartTotal.textContent = `Total: Rf ${total.toFixed(2)}`;
            
            // Add event listeners to quantity buttons
            document.querySelectorAll('.decrease-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const index = parseInt(btn.dataset.index);
                    decreaseQuantity(index);
                });
            });
            
            document.querySelectorAll('.increase-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const index = parseInt(btn.dataset.index);
                    increaseQuantity(index);
                });
            });
        }

        // Decrease item quantity
        function decreaseQuantity(index) {
            if (cart[index].quantity > 1) {
                cart[index].quantity--;
            } else {
                cart.splice(index, 1);
            }
            updateCart();
        }

        // Increase item quantity
        function increaseQuantity(index) {
            // Check if we have enough stock
            if (cart[index].quantity >= cart[index].maxStock) {
                showNotification(`Not enough stock for ${cart[index].name}. Only ${cart[index].maxStock} available.`, 'error');
                return;
            }
            cart[index].quantity++;
            updateCart();
        }

        // Clear cart
        function clearCart() {
            cart = [];
            updateCart();
            clearSelectedCustomer();
            customerNameInput.value = '';
            customerPhoneInput.value = '';
        }

        // Hold order
        function holdOrder() {
            if (!currentTable) {
                showNotification('Please select a table first', 'error');
                return;
            }
            
            if (cart.length === 0) {
                showNotification('Cart is empty', 'error');
                return;
            }
            
            let customerPhone = '';
            let customerName = '';
            
            if (customerType === 'credit') {
                if (!selectedCustomer) {
                    showNotification('Please select a credit customer first', 'error');
                    return;
                }
                customerPhone = selectedCustomer.contact;
                customerName = selectedCustomer.name;
            } else {
                customerPhone = customerPhoneInput.value.trim();
                customerName = customerNameInput.value.trim();
            }
            
            const order = {
                table: currentTable,
                customerType: customerType,
                customerName: customerName,
                customerPhone: customerPhone,
                items: [...cart],
                total: cart.reduce((sum, item) => sum + (item.price * item.quantity), 0),
                createdAt: new Date().toISOString()
            };
            
            // If it's a credit customer, add customer ID
            if (customerType === 'credit' && selectedCustomer) {
                order.customerId = selectedCustomer.id;
            }
            
            database.ref('heldOrders/' + currentTable).set(order)
                .then(() => {
                    showNotification(`Order held for Table ${currentTable}`);
                    clearCart();
                    loadHeldOrders();
                    
                    // Mark table as occupied
                    database.ref('tables/' + currentTable).set({
                        status: 'occupied',
                        orderId: currentTable
                    }).then(() => {
                        loadTables();
                    });
                })
                .catch(error => {
                    showNotification('Error holding order: ' + error.message, 'error');
                });
        }

        // Load held orders
        function loadHeldOrders() {
            database.ref('heldOrders').once('value').then(snapshot => {
                const orders = snapshot.val();
                heldOrdersTable.innerHTML = '';
                
                if (orders) {
                    Object.entries(orders).forEach(([tableNumber, order]) => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${tableNumber}</td>
                            <td>${order.customerPhone || 'N/A'}</td>
                            <td>${order.items.length} items</td>
                            <td>Rf ${order.total.toFixed(2)}</td>
                            <td>${new Date(order.createdAt).toLocaleTimeString()}</td>
                            <td class="action-buttons">
                                <button class="btn btn-secondary load-held-order" data-table="${tableNumber}">Load</button>
                                <button class="btn btn-danger delete-held-order" data-table="${tableNumber}">Delete</button>
                            </td>
                        `;
                        heldOrdersTable.appendChild(row);
                    });
                    
                    // Add event listeners to load buttons
                    document.querySelectorAll('.load-held-order').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const tableNumber = btn.dataset.table;
                            loadHeldOrderForTable(tableNumber);
                        });
                    });
                    
                    // Add event listeners to delete buttons
                    document.querySelectorAll('.delete-held-order').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const tableNumber = btn.dataset.table;
                            deleteHeldOrder(tableNumber);
                        });
                    });
                }
            });
        }

        // Load held order for table
        function loadHeldOrderForTable(tableNumber) {
            database.ref('heldOrders/' + tableNumber).once('value').then(snapshot => {
                const order = snapshot.val();
                if (order) {
                    // Select the table
                    selectTable(parseInt(tableNumber));
                    
                    // Set customer type and load appropriate data
                    if (order.customerType === 'credit' && order.customerId) {
                        selectCustomerType('credit');
                        database.ref('creditCustomers/' + order.customerId).once('value').then(customerSnapshot => {
                            const customer = customerSnapshot.val();
                            if (customer) {
                                selectCustomer(order.customerId, customer);
                            }
                        });
                    } else {
                        selectCustomerType('regular');
                        if (order.customerName) customerNameInput.value = order.customerName;
                        if (order.customerPhone) customerPhoneInput.value = order.customerPhone;
                    }
                    
                    // Update product stock information before loading
                    updateCartItemsWithCurrentStock(order.items).then(updatedItems => {
                        // Load items to cart with updated stock info
                        cart = updatedItems;
                        updateCart();
                        
                        // Clear the held order after loading
                        database.ref('heldOrders/' + tableNumber).remove()
                            .then(() => {
                                // Mark table as available
                                database.ref('tables/' + tableNumber).remove()
                                    .then(() => {
                                        showNotification(`Loaded held order for Table ${tableNumber}`);
                                        loadHeldOrders();
                                        loadTables();
                                    });
                            });
                    });
                }
            });
        }

        // Update cart items with current stock information
        function updateCartItemsWithCurrentStock(items) {
            return new Promise((resolve) => {
                database.ref('products').once('value').then(snapshot => {
                    const products = snapshot.val();
                    const updatedItems = items.map(item => {
                        if (products && products[item.id]) {
                            return {
                                ...item,
                                maxStock: products[item.id].stock
                            };
                        }
                        return item;
                    });
                    resolve(updatedItems);
                });
            });
        }

        // Delete held order
        function deleteHeldOrder(tableNumber) {
            if (confirm('Are you sure you want to delete this held order?')) {
                database.ref('heldOrders/' + tableNumber).remove()
                    .then(() => {
                        // Mark table as available
                        database.ref('tables/' + tableNumber).remove()
                            .then(() => {
                                showNotification('Held order deleted');
                                loadHeldOrders();
                                loadTables();
                            });
                    })
                    .catch(error => {
                        showNotification('Error deleting held order: ' + error.message, 'error');
                    });
            }
        }

        // Complete order
        function completeOrder() {
            if (!currentTable) {
                showNotification('Please select a table first', 'error');
                return;
            }
            
            if (cart.length === 0) {
                showNotification('Cart is empty', 'error');
                return;
            }
            
            const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
            
            // If payment method is credit, validate customer selection
            if (paymentMethod === 'credit') {
                if (customerType === 'credit') {
                    if (!selectedCustomer) {
                        showNotification('Please select a customer for credit payment', 'error');
                        return;
                    }
                } else {
                    // For regular customers wanting credit, we need to create a credit customer first
                    if (!customerNameInput.value.trim() || !customerPhoneInput.value.trim()) {
                        showNotification('Please enter customer name and phone for credit payment', 'error');
                        return;
                    }
                    
                    // Check if customer already exists
                    const customerPhone = customerPhoneInput.value.trim();
                    database.ref('creditCustomers').orderByChild('contact').equalTo(customerPhone).once('value')
                        .then(snapshot => {
                            if (snapshot.exists()) {
                                showNotification('Customer already exists in credit system. Please select from credit customers.', 'error');
                                return;
                            } else {
                                // Create new credit customer
                                createCreditCustomerFromOrder().then(customerId => {
                                    completeCreditOrderWithNewCustomer(customerId);
                                });
                            }
                        });
                    return;
                }
            }
            
            const customerPhone = customerType === 'credit' ? selectedCustomer.contact : customerPhoneInput.value.trim();
            const customerName = customerType === 'credit' ? selectedCustomer.name : customerNameInput.value.trim();
            const orderNumber = generateOrderNumber();
            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            const order = {
                orderNumber,
                customerPhone,
                customerName,
                items: cart,
                total,
                paymentMethod,
                table: currentTable,
                status: 'completed',
                createdAt: new Date().toISOString()
            };
            
            // If customer is selected, add customer info
            if (customerType === 'credit' && selectedCustomer) {
                order.customerId = selectedCustomer.id;
            }
            
            // If payment method is credit, handle credit transaction
            if (paymentMethod === 'credit') {
                handleCreditOrder(order);
            } else {
                // For cash/bank transfer, complete the order normally
                completeRegularOrder(order);
            }
        }

        // Create credit customer from order details
        function createCreditCustomerFromOrder() {
            return new Promise((resolve) => {
                const customer = {
                    name: customerNameInput.value.trim(),
                    contact: customerPhoneInput.value.trim(),
                    creditLimit: 1000, // Default credit limit
                    creditDays: defaultCreditDays,
                    status: 'active',
                    createdAt: new Date().toISOString()
                };
                
                database.ref('creditCustomers').push(customer)
                    .then((ref) => {
                        const customerId = ref.key;
                        showNotification('New credit customer created');
                        resolve(customerId);
                    })
                    .catch(error => {
                        showNotification('Error creating credit customer: ' + error.message, 'error');
                        resolve(null);
                    });
            });
        }

        // Complete credit order with new customer
        function completeCreditOrderWithNewCustomer(customerId) {
            if (!customerId) return;
            
            const customerName = customerNameInput.value.trim();
            const customerPhone = customerPhoneInput.value.trim();
            const orderNumber = generateOrderNumber();
            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            const order = {
                orderNumber,
                customerPhone,
                customerName,
                customerId: customerId,
                items: cart,
                total,
                paymentMethod: 'credit',
                table: currentTable,
                status: 'completed',
                createdAt: new Date().toISOString()
            };
            
            handleCreditOrder(order, customerId, customerName);
        }

        // Handle credit order
        function handleCreditOrder(order, customerId = null, customerName = null) {
            const customerIdToUse = customerId || order.customerId;
            const customerNameToUse = customerName || order.customerName;
            
            // Check credit limit
            getOutstandingBalance(customerIdToUse).then(balance => {
                database.ref('creditCustomers/' + customerIdToUse).once('value').then(customerSnapshot => {
                    const customer = customerSnapshot.val();
                    if (!customer) return;
                    
                    if (balance + order.total > customer.creditLimit) {
                        showNotification(`Credit limit exceeded for ${customerNameToUse}. Available credit: Rf ${(customer.creditLimit - balance).toFixed(2)}`, 'error');
                        return;
                    }
                    
                    // Proceed with credit order
                    completeCreditOrder(order, customerIdToUse, customerNameToUse);
                });
            });
        }

        // Get outstanding balance for a customer
        function getOutstandingBalance(customerId) {
            return new Promise((resolve) => {
                database.ref('creditTransactions').orderByChild('customerId').equalTo(customerId).once('value')
                    .then(snapshot => {
                        let balance = 0;
                        if (snapshot.exists()) {
                            const transactions = snapshot.val();
                            Object.values(transactions).forEach(transaction => {
                                if (transaction.status !== 'paid') {
                                    balance += transaction.amount || 0;
                                }
                            });
                        }
                        resolve(balance);
                    });
            });
        }

        // Complete credit order
        function completeCreditOrder(order, customerId, customerName) {
            // First update product stocks
            updateProductStocks()
                .then(() => {
                    // Save order
                    return database.ref('posOrders').push({
                        ...order,
                        creditStatus: 'pending',
                        customerId: customerId
                    });
                })
                .then((orderRef) => {
                    // Create credit transaction
                    const dueDate = new Date();
                    dueDate.setDate(dueDate.getDate() + defaultCreditDays);
                    
                    return database.ref('creditTransactions').push({
                        orderId: orderRef.key,
                        orderNumber: order.orderNumber,
                        customerId: customerId,
                        customerName: customerName,
                        amount: order.total,
                        paid: 0,
                        due: order.total,
                        dueDate: dueDate.toISOString().split('T')[0],
                        status: 'pending',
                        createdAt: new Date().toISOString()
                    });
                })
                .then(() => {
                    // Remove any held order for this table
                    return database.ref('heldOrders/' + currentTable).remove();
                })
                .then(() => {
                    // Mark table as available
                    return database.ref('tables/' + currentTable).remove();
                })
                .then(() => {
                    showNotification(`Credit order completed for Table ${currentTable}`);
                    generateBill(order);
                    clearCart();
                    loadHeldOrders();
                    loadTables();
                    loadProductsForPOS(); // Refresh product list to update stock display
                    loadDashboardData(); // Update dashboard stats
                    loadCreditTransactions(); // Refresh credit transactions
                })
                .catch(error => {
                    showNotification('Error completing credit order: ' + error.message, 'error');
                });
        }

        // Complete regular order
        function completeRegularOrder(order) {
            // First update product stocks
            updateProductStocks()
                .then(() => {
                    // Save order
                    return database.ref('posOrders').push(order);
                })
                .then(() => {
                    // Remove any held order for this table
                    return database.ref('heldOrders/' + currentTable).remove();
                })
                .then(() => {
                    // Mark table as available
                    return database.ref('tables/' + currentTable).remove();
                })
                .then(() => {
                    showNotification(`Order completed for Table ${currentTable}`);
                    generateBill(order);
                    clearCart();
                    loadHeldOrders();
                    loadTables();
                    loadProductsForPOS(); // Refresh product list to update stock display
                    loadDashboardData(); // Update dashboard stats
                })
                .catch(error => {
                    showNotification('Error completing order: ' + error.message, 'error');
                });
        }

        // Update product stocks after order completion
        function updateProductStocks() {
            const updates = {};
            
            cart.forEach(item => {
                updates[`products/${item.id}/stock`] = firebase.database.ServerValue.increment(-item.quantity);
            });
            
            return database.ref().update(updates);
        }

        // Generate order number
        function generateOrderNumber() {
            const now = new Date();
            const year = now.getFullYear().toString().substr(-2);
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const day = now.getDate().toString().padStart(2, '0');
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            return `POS-${year}${month}${day}-${random}`;
        }

        // Generate bill
        function generateBill(order) {
            const billModalBody = document.getElementById('billModalBody');
            const billModalTitle = document.getElementById('billModalTitle');
            
            // Update bill title with custom invoice name
            billModalTitle.textContent = `${invoiceName} - Bill`;
            
            let billHTML = `
                <div class="bill-container">
                    <div class="bill-header">
                        <h2>${invoiceName}</h2>
                        <p>Order #: ${order.orderNumber}</p>
                        <p>Date: ${new Date().toLocaleString()}</p>
                        <p>Table: ${order.table}</p>
                        ${order.customerName ? `<p>Customer: ${order.customerName}</p>` : ''}
                        <p>Phone: ${order.customerPhone || 'N/A'}</p>
                    </div>
                    <div class="bill-items">
            `;
            
            order.items.forEach(item => {
                billHTML += `
                    <div class="bill-item">
                        <div class="product-name-dhivehi">${item.name} x ${item.quantity}</div>
                        <div>Rf ${(item.price * item.quantity).toFixed(2)}</div>
                    </div>
                `;
            });
            
            billHTML += `
                    </div>
                    <div class="bill-total">
                        Total: Rf ${order.total.toFixed(2)}
                    </div>
                    <div class="payment-method">
                        Payment Method: ${order.paymentMethod === 'cash' ? 'Cash' : order.paymentMethod === 'bank-transfer' ? 'Bank Transfer' : 'Credit'}
                    </div>
            `;
            
            // Add credit information if payment method is credit
            if (order.paymentMethod === 'credit') {
                const dueDate = new Date();
                dueDate.setDate(dueDate.getDate() + defaultCreditDays);
                billHTML += `
                    <div class="credit-info">
                        <p>Due Date: ${dueDate.toLocaleDateString()}</p>
                    </div>
                `;
            }
            
            billHTML += `
                    <div class="thank-you">
                        <p>Thank you for your visit!</p>
                    </div>
                </div>
            `;
            
            billModalBody.innerHTML = billHTML;
            billModal.style.display = 'block';
        }

        // Print bill
        function printBill() {
            const printContent = document.getElementById('billModalBody').innerHTML;
            const originalContent = document.body.innerHTML;
            
            document.body.innerHTML = printContent;
            window.print();
            document.body.innerHTML = originalContent;
            
            // Reinitialize event listeners
            initAdmin();
        }

        // Load products
        function loadProducts() {
            if (!userAccess.includes('products')) return;
            
            database.ref('products').once('value').then(snapshot => {
                const products = snapshot.val();
                const productsTable = document.getElementById('productsTable').querySelector('tbody');
                productsTable.innerHTML = '';
                
                if (products) {
                    Object.entries(products).forEach(([id, product]) => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td><img src="${product.image}" alt="${product.name}" style="width: 50px; height: 50px; object-fit: cover;"></td>
                            <td class="product-name-dhivehi">${product.name}</td>
                            <td class="category-name-dhivehi">${product.category}</td>
                            <td>Rf ${product.price?.toFixed(2) || '0.00'}</td>
                            <td>${product.stock || 0}</td>
                            <td class="action-buttons">
                                <button class="btn btn-secondary edit-product" data-id="${id}">Edit</button>
                                <button class="btn btn-danger delete-product" data-id="${id}">Delete</button>
                            </td>
                        `;
                        productsTable.appendChild(row);
                    });
                }
                
                // Add event listeners to action buttons
                document.querySelectorAll('.edit-product').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const productId = btn.dataset.id;
                        editProduct(productId);
                    });
                });
                
                document.querySelectorAll('.delete-product').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const productId = btn.dataset.id;
                        deleteProduct(productId);
                    });
                });
            });
        }

        // Load categories
        function loadCategories() {
            if (!userAccess.includes('categories')) return;
            
            database.ref('categories').once('value').then(snapshot => {
                const categories = snapshot.val();
                const categoriesTable = document.getElementById('categoriesTable').querySelector('tbody');
                const categorySelect = document.getElementById('productCategory');
                const stockCategoryFilter = document.getElementById('stockCategoryFilter');
                
                categoriesTable.innerHTML = '';
                categorySelect.innerHTML = '<option value="">Select Category</option>';
                stockCategoryFilter.innerHTML = '<option value="">All Categories</option>';
                
                if (categories) {
                    Object.entries(categories).forEach(([id, category]) => {
                        // Add to table
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td class="category-name-dhivehi">${category}</td>
                            <td class="action-buttons">
                                <button class="btn btn-danger delete-category" data-id="${id}">Delete</button>
                            </td>
                        `;
                        categoriesTable.appendChild(row);
                        
                        // Add to select
                        const option = document.createElement('option');
                        option.value = category;
                        option.innerHTML = `<span class="category-name-dhivehi">${category}</span>`;
                        categorySelect.appendChild(option);
                        
                        // Add to stock filter
                        const stockOption = document.createElement('option');
                        stockOption.value = category;
                        stockOption.innerHTML = `<span class="category-name-dhivehi">${category}</span>`;
                        stockCategoryFilter.appendChild(stockOption);
                    });
                }
                
                // Load categories for POS filtering
                loadCategoriesForPOS();
                
                // Add event listeners to delete buttons
                document.querySelectorAll('.delete-category').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const categoryId = btn.dataset.id;
                        deleteCategory(categoryId);
                    });
                });
            });
        }

        // Load orders with filters
        function loadOrders() {
            if (!userAccess.includes('orders')) return;
            
            const statusFilter = document.getElementById('orderStatusFilter').value;
            const dateFrom = document.getElementById('orderDateFrom').value;
            const dateTo = document.getElementById('orderDateTo').value;
            
            // Load both regular orders and POS orders
            Promise.all([
                database.ref('orders').once('value'),
                database.ref('posOrders').once('value')
            ]).then(([ordersSnapshot, posOrdersSnapshot]) => {
                const orders = ordersSnapshot.val();
                const posOrders = posOrdersSnapshot.val();
                const ordersTable = document.getElementById('ordersTable').querySelector('tbody');
                ordersTable.innerHTML = '';
                
                // Process regular orders
                if (orders) {
                    Object.entries(orders).forEach(([id, order]) => {
                        // Apply filters
                        if (statusFilter && order.status !== statusFilter) return;
                        if (dateFrom && order.date < dateFrom) return;
                        if (dateTo && order.date > dateTo) return;
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${order.orderNumber || id}</td>
                            <td>${order.shippingInfo?.name || 'N/A'}</td>
                            <td>${order.shippingInfo?.phone || 'N/A'}</td>
                            <td>${order.date || 'N/A'}</td>
                            <td>Rf ${(order.total || 0).toFixed(2)}</td>
                            <td>${order.paymentMethod || 'N/A'}</td>
                            <td>${order.status || 'pending'}</td>
                            <td class="action-buttons">
                                <button class="btn btn-secondary view-order" data-id="${id}" data-type="order">View</button>
                                <button class="btn btn-danger delete-order" data-id="${id}" data-type="order">Delete</button>
                            </td>
                        `;
                        ordersTable.appendChild(row);
                    });
                }
                
                // Process POS orders
                if (posOrders) {
                    Object.entries(posOrders).forEach(([id, order]) => {
                        // Apply filters
                        if (statusFilter && order.status !== statusFilter) return;
                        if (dateFrom && order.date < dateFrom) return;
                        if (dateTo && order.date > dateTo) return;
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${order.orderNumber || id}</td>
                            <td>${order.customerName || 'Table ' + (order.table || 'N/A')}</td>
                            <td>${order.customerPhone || 'N/A'}</td>
                            <td>${new Date(order.createdAt).toLocaleDateString() || 'N/A'}</td>
                            <td>Rf ${(order.total || 0).toFixed(2)}</td>
                            <td>${order.paymentMethod || 'N/A'}</td>
                            <td>${order.status || 'completed'}</td>
                            <td class="action-buttons">
                                <button class="btn btn-secondary view-order" data-id="${id}" data-type="posOrder">View</button>
                                <button class="btn btn-danger delete-order" data-id="${id}" data-type="posOrder">Delete</button>
                            </td>
                        `;
                        ordersTable.appendChild(row);
                    });
                }
                
                // Add event listeners to view buttons
                document.querySelectorAll('.view-order').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const orderId = btn.dataset.id;
                        const orderType = btn.dataset.type;
                        viewOrder(orderId, orderType);
                    });
                });
                
                // Add event listeners to delete buttons
                document.querySelectorAll('.delete-order').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const orderId = btn.dataset.id;
                        const orderType = btn.dataset.type;
                        if (confirm('Are you sure you want to delete this order?')) {
                            deleteOrder(orderId, orderType);
                        }
                    });
                });
            });
        }

        // View order details
        function viewOrder(orderId, orderType = 'order') {
            const refPath = orderType === 'posOrder' ? 'posOrders/' + orderId : 'orders/' + orderId;
            
            database.ref(refPath).once('value').then(snapshot => {
                const order = snapshot.val();
                if (!order) return;
                
                currentOrderId = orderId;
                
                const modalBody = document.getElementById('orderModalBody');
                let orderHTML = `
                    <div class="form-group">
                        <label>Order Number</label>
                        <p>${order.orderNumber || orderId}</p>
                    </div>
                    <div class="form-group">
                        <label>Order Date</label>
                        <p>${order.date || new Date(order.createdAt).toLocaleDateString() || 'N/A'}</p>
                    </div>
                `;
                
                if (orderType === 'order') {
                    orderHTML += `
                        <div class="form-group">
                            <label>Customer Name</label>
                            <p>${order.shippingInfo?.name || 'N/A'}</p>
                        </div>
                        <div class="form-group">
                            <label>Customer Phone</label>
                            <p>${order.shippingInfo?.phone || 'N/A'}</p>
                        </div>
                        <div class="form-group">
                            <label>Shipping Address</label>
                            <p>${order.shippingInfo?.address || 'N/A'}, ${order.shippingInfo?.island || 'N/A'}</p>
                        </div>
                    `;
                } else {
                    orderHTML += `
                        <div class="form-group">
                            <label>Table Number</label>
                            <p>${order.table || 'N/A'}</p>
                        </div>
                        <div class="form-group">
                            <label>Customer Name</label>
                            <p>${order.customerName || 'N/A'}</p>
                        </div>
                        <div class="form-group">
                            <label>Customer Phone</label>
                            <p>${order.customerPhone || 'N/A'}</p>
                        </div>
                    `;
                }
                
                orderHTML += `
                    <div class="form-group">
                        <label>Payment Method</label>
                        <p>${order.paymentMethod || 'N/A'}</p>
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <p>${order.status || 'pending'}</p>
                    </div>
                    <div class="form-group">
                        <label>Total Amount</label>
                        <p>Rf ${order.total?.toFixed(2) || '0.00'}</p>
                    </div>
                    ${order.paymentSlip ? `
                    <div class="form-group">
                        <label>Payment Slip</label>
                        <img src="${order.paymentSlip}" alt="Payment Slip" class="payment-slip">
                    </div>
                    ` : ''}
                    <div class="form-group">
                        <label>Items</label>
                        <ul>
                            ${order.items ? order.items.map(item => `
                                <li class="product-name-dhivehi">${item.name} x ${item.quantity} - Rf ${(item.price * item.quantity).toFixed(2)}</li>
                            `).join('') : '<li>No items</li>'}
                        </ul>
                    </div>
                `;
                
                modalBody.innerHTML = orderHTML;
                
                // Show credit button if order is not already a credit order
                if (order.paymentMethod !== 'credit') {
                    creditOrderBtn.style.display = 'block';
                } else {
                    creditOrderBtn.style.display = 'none';
                }
                
                orderModal.style.display = 'block';
            });
        }

        // Send order to credit
        function sendOrderToCredit() {
            if (!currentOrderId) return;
            
            // Get order details
            database.ref('orders/' + currentOrderId).once('value').then(snapshot => {
                const order = snapshot.val();
                if (!order) return;
                
                // Check if customer exists in credit system
                const customerPhone = order.shippingInfo?.phone;
                if (!customerPhone) {
                    showNotification('Customer phone number is required for credit orders', 'error');
                    return;
                }
                
                database.ref('creditCustomers').orderByChild('contact').equalTo(customerPhone).once('value')
                    .then(customerSnapshot => {
                        if (customerSnapshot.exists()) {
                            // Customer exists, convert to credit order
                            const customerData = customerSnapshot.val();
                            const customerId = Object.keys(customerData)[0];
                            const customer = customerData[customerId];
                            
                            // Check credit limit
                            getOutstandingBalance(customerId).then(balance => {
                                if (balance + order.total > customer.creditLimit) {
                                    showNotification(`Credit limit exceeded for ${customer.name}. Available credit: Rf ${(customer.creditLimit - balance).toFixed(2)}`, 'error');
                                    return;
                                }
                                
                                // Update order to credit
                                database.ref('orders/' + currentOrderId).update({
                                    paymentMethod: 'credit',
                                    creditStatus: 'pending',
                                    customerId: customerId
                                }).then(() => {
                                    // Create credit transaction
                                    const dueDate = new Date();
                                    dueDate.setDate(dueDate.getDate() + defaultCreditDays);
                                    
                                    database.ref('creditTransactions').push({
                                        orderId: currentOrderId,
                                        orderNumber: order.orderNumber,
                                        customerId: customerId,
                                        customerName: customer.name,
                                        amount: order.total,
                                        paid: 0,
                                        due: order.total,
                                        dueDate: dueDate.toISOString().split('T')[0],
                                        status: 'pending',
                                        createdAt: new Date().toISOString()
                                    }).then(() => {
                                        showNotification('Order converted to credit successfully!');
                                        orderModal.style.display = 'none';
                                        loadOrders();
                                        loadCreditTransactions();
                                        loadDashboardData();
                                    });
                                });
                            });
                        } else {
                            // Customer doesn't exist, ask to create new customer
                            if (confirm('Customer not found in credit system. Would you like to create a new credit customer?')) {
                                // Show customer creation form
                                document.getElementById('customerName').value = order.shippingInfo?.name || '';
                                document.getElementById('customerContact').value = customerPhone;
                                document.getElementById('creditLimit').value = Math.ceil(order.total * 1.5); // Set limit 50% higher than order total
                                
                                // Switch to add customer tab
                                document.querySelectorAll('.tab').forEach(tab => {
                                    tab.classList.remove('active');
                                });
                                document.querySelector('[data-subtab="add-customer"]').classList.add('active');
                                
                                document.querySelectorAll('.tab-content').forEach(content => {
                                    content.classList.remove('active');
                                });
                                document.getElementById('add-customer').classList.add('active');
                                
                                // Switch to credit tab
                                switchTab('credit');
                                
                                showNotification('Please create a new credit customer to convert this order to credit', 'warning');
                            }
                        }
                    });
            });
        }

        // Delete order
        function deleteOrder(orderId = null, orderType = 'order') {
            const idToDelete = orderId || currentOrderId;
            if (!idToDelete) return;
            
            const refPath = orderType === 'posOrder' ? 'posOrders/' + idToDelete : 'orders/' + idToDelete;
            
            if (confirm('Are you sure you want to delete this order? This action cannot be undone.')) {
                database.ref(refPath).remove()
                    .then(() => {
                        showNotification('Order deleted successfully!');
                        orderModal.style.display = 'none';
                        loadDashboardData();
                        loadOrders();
                    })
                    .catch(error => {
                        showNotification('Error deleting order: ' + error.message, 'error');
                    });
            }
        }

        // Delete product
        function deleteProduct(productId) {
            if (confirm('Are you sure you want to delete this product? This action cannot be undone.')) {
                database.ref('products/' + productId).remove()
                    .then(() => {
                        showNotification('Product deleted successfully!');
                        loadProducts();
                        loadStock();
                    })
                    .catch(error => {
                        showNotification('Error deleting product: ' + error.message, 'error');
                    });
            }
        }

        // Delete category
        function deleteCategory(categoryId) {
            if (confirm('Are you sure you want to delete this category? This action cannot be undone.')) {
                database.ref('categories/' + categoryId).remove()
                    .then(() => {
                        showNotification('Category deleted successfully!');
                        loadCategories();
                    })
                    .catch(error => {
                        showNotification('Error deleting category: ' + error.message, 'error');
                    });
            }
        }

        // Add product
        function addProduct(e) {
            e.preventDefault();
            
            const product = {
                name: document.getElementById('productName').value,
                category: document.getElementById('productCategory').value,
                price: parseFloat(document.getElementById('productPrice').value),
                stock: parseInt(document.getElementById('productStock').value),
                image: document.getElementById('productImage').value,
                createdAt: new Date().toISOString()
            };
            
            database.ref('products').push(product)
                .then(() => {
                    showNotification('Product added successfully!');
                    document.getElementById('addProductForm').reset();
                    loadProducts();
                    loadStock();
                    loadCategoriesForPOS(); // Refresh POS categories
                })
                .catch(error => {
                    showNotification('Error adding product: ' + error.message, 'error');
                });
        }

        // Add category
        function addCategory(e) {
            e.preventDefault();
            
            const category = document.getElementById('categoryName').value;
            
            database.ref('categories').push(category)
                .then(() => {
                    showNotification('Category added successfully!');
                    document.getElementById('addCategoryForm').reset();
                    loadCategories();
                })
                .catch(error => {
                    showNotification('Error adding category: ' + error.message, 'error');
                });
        }
// Load stock management
function loadStock() {
    if (!userAccess.includes('stock')) return;
    
    const categoryFilter = document.getElementById('stockCategoryFilter').value;
    const statusFilter = document.getElementById('stockStatusFilter').value;
    
    database.ref('products').once('value').then(snapshot => {
        const products = snapshot.val();
        const stockTable = document.getElementById('stockTable').querySelector('tbody');
        stockTable.innerHTML = '';
        
        if (products) {
            Object.entries(products).forEach(([id, product]) => {
                // Apply filters
                if (categoryFilter && product.category !== categoryFilter) return;
                
                if (statusFilter === 'low' && product.stock > 5) return;
                if (statusFilter === 'out' && product.stock > 0) return;
                if (statusFilter === 'in' && product.stock <= 0) return;
                
                const status = product.stock <= 0 ? 'Out of Stock' : 
                              product.stock <= 5 ? 'Low Stock' : 'In Stock';
                
                const statusClass = product.stock <= 0 ? 'stock-low' : 
                                  product.stock <= 5 ? 'stock-low' : '';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><img src="${product.image}" alt="${product.name}" style="width: 50px; height: 50px; object-fit: cover;"></td>
                    <td class="product-name-dhivehi">${product.name}</td>
                    <td class="category-name-dhivehi">${product.category}</td>
                    <td>${product.stock || 0}</td>
                    <td>Rf ${product.price?.toFixed(2) || '0.00'}</td>
                    <td class="${statusClass}">${status}</td>
                    <td class="action-buttons">
                        <button class="btn btn-secondary edit-stock" data-id="${id}">Edit</button>
                    </td>
                `;
                stockTable.appendChild(row);
            });
            
            // Add event listeners to edit buttons
            document.querySelectorAll('.edit-stock').forEach(btn => {
                btn.addEventListener('click', () => {
                    const productId = btn.dataset.id;
                    editStock(productId);
                });
            });
        }
    }).catch(error => {
        console.error('Error loading stock:', error);
        showNotification('Error loading stock data', 'error');
    });
}

// Edit stock - NEW FUNCTION TO ADD
function editStock(productId) {
    database.ref('products/' + productId).once('value').then(snapshot => {
        const product = snapshot.val();
        if (!product) return;
        
        currentEditingProductId = productId;
        
        const modalBody = document.getElementById('stockModalBody');
        modalBody.innerHTML = `
            <div class="form-group">
                <label for="editStock">Current Stock</label>
                <input type="number" id="editStock" value="${product.stock || 0}" min="0" required>
            </div>
            <div class="form-group">
                <label for="editPrice">Price (Rf)</label>
                <input type="number" id="editPrice" value="${product.price || 0}" min="0" step="0.01" required>
            </div>
        `;
        
        stockModal.style.display = 'block';
    }).catch(error => {
        showNotification('Error loading product details: ' + error.message, 'error');
    });
}

// Save stock changes
function saveStockChanges() {
    const newStock = parseInt(document.getElementById('editStock').value);
    const newPrice = parseFloat(document.getElementById('editPrice').value);
    
    if (isNaN(newStock) || isNaN(newPrice) || newStock < 0 || newPrice < 0) {
        showNotification('Please enter valid numbers', 'error');
        return;
    }
    
    const updates = {
        stock: newStock,
        price: newPrice
    };
    
    database.ref('products/' + currentEditingProductId).update(updates)
        .then(() => {
            showNotification('Stock and price updated successfully!');
            stockModal.style.display = 'none';
            loadProducts();
            loadStock();
            loadProductsForPOS();
        })
        .catch(error => {
            showNotification('Error updating stock: ' + error.message, 'error');
        });
}
        // Add expense
        function addExpense(e) {
            e.preventDefault();
            
            const expense = {
                date: document.getElementById('expenseDate').value,
                supplier: document.getElementById('expenseSupplier').value,
                invoiceNumber: document.getElementById('expenseInvoice').value,
                purpose: document.getElementById('expensePurpose').value,
                amount: parseFloat(document.getElementById('expenseAmount').value),
                notes: document.getElementById('expenseNotes').value,
                createdAt: new Date().toISOString()
            };
            
            database.ref('expenses').push(expense)
                .then(() => {
                    showNotification('Expense added successfully!');
                    addExpenseForm.reset();
                    loadExpenses();
                    loadDashboardData();
                })
                .catch(error => {
                    showNotification('Error adding expense: ' + error.message, 'error');
                });
        }

       // Load expenses
function loadExpenses() {
    if (!userAccess.includes('expenses')) return;
    
    const dateFrom = document.getElementById('expenseDateFrom').value;
    const dateTo = document.getElementById('expenseDateTo').value;
    
    database.ref('expenses').once('value').then(snapshot => {
        const expenses = snapshot.val();
        expensesTable.innerHTML = '';
        
        let totalAmount = 0;
        
        if (expenses) {
            Object.entries(expenses).forEach(([id, expense]) => {
                // Apply date filters
                if (dateFrom && expense.date < dateFrom) return;
                if (dateTo && expense.date > dateTo) return;
                
                totalAmount += expense.amount || 0;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${expense.date}</td>
                    <td>${expense.supplier}</td>
                    <td>${expense.invoiceNumber}</td>
                    <td>${expense.purpose}</td>
                    <td>Rf ${expense.amount?.toFixed(2) || '0.00'}</td>
                    <td>${expense.notes || ''}</td>
                    <td class="action-buttons">
                        <button class="btn btn-danger delete-expense" data-id="${id}">Delete</button>
                    </td>
                `;
                expensesTable.appendChild(row);
            });
            
            // Add event listeners to delete buttons
            document.querySelectorAll('.delete-expense').forEach(btn => {
                btn.addEventListener('click', () => {
                    const expenseId = btn.dataset.id;
                    deleteExpense(expenseId);
                });
            });
        }
        
        // Update footer with total
        expensesTableFooter.innerHTML = `
            <tr>
                <td colspan="4" style="text-align: right; font-weight: bold;">Total:</td>
                <td style="font-weight: bold;">Rf ${totalAmount.toFixed(2)}</td>
                <td colspan="2"></td>
            </tr>
        `;
    }).catch(error => {
        console.error('Error loading expenses:', error);
        showNotification('Error loading expenses data', 'error');
    });
}

// Delete expense - NEW FUNCTION TO ADD
function deleteExpense(expenseId) {
    if (confirm('Are you sure you want to delete this expense? This action cannot be undone.')) {
        database.ref('expenses/' + expenseId).remove()
            .then(() => {
                showNotification('Expense deleted successfully!');
                loadExpenses();
                loadDashboardData();
            })
            .catch(error => {
                showNotification('Error deleting expense: ' + error.message, 'error');
            });
    }
}

        // Add customer
        function addCustomer(e) {
            e.preventDefault();
            
            const customer = {
                name: document.getElementById('customerName').value,
                contact: document.getElementById('customerContact').value,
                address: document.getElementById('customerAddress').value,
                creditLimit: parseFloat(document.getElementById('creditLimit').value),
                creditDays: parseInt(document.getElementById('creditDays').value),
                status: 'active',
                createdAt: new Date().toISOString()
            };
            
            database.ref('creditCustomers').push(customer)
                .then(() => {
                    showNotification('Customer added successfully!');
                    addCustomerForm.reset();
                    loadCreditCustomers();
                })
                .catch(error => {
                    showNotification('Error adding customer: ' + error.message, 'error');
                });
        }

        // Load credit customers
        function loadCreditCustomers() {
            if (!userAccess.includes('credit')) return;
            
            const statusFilter = document.getElementById('customerStatusFilter').value;
            
            database.ref('creditCustomers').once('value').then(snapshot => {
                const customers = snapshot.val();
                customersTable.innerHTML = '';
                
                if (customers) {
                    Object.entries(customers).forEach(([id, customer]) => {
                        // Apply status filter
                        if (statusFilter && customer.status !== statusFilter) return;
                        
                        // Get outstanding balance
                        getOutstandingBalance(id).then(balance => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${customer.name}</td>
                                <td>${customer.contact}</td>
                                <td>Rf ${customer.creditLimit?.toFixed(2) || '0.00'}</td>
                                <td>Rf ${balance.toFixed(2)}</td>
                                <td>${customer.status || 'active'}</td>
                                <td class="action-buttons">
                                    <button class="btn btn-secondary view-customer" data-id="${id}">View</button>
                                    <button class="btn btn-danger delete-customer" data-id="${id}">Delete</button>
                                </td>
                            `;
                            customersTable.appendChild(row);
                            
                            // Add event listeners
                            row.querySelector('.view-customer').addEventListener('click', () => {
                                viewCustomer(id);
                            });
                            
                            row.querySelector('.delete-customer').addEventListener('click', () => {
                                deleteCustomer(id);
                            });
                        });
                    });
                }
            });
        }

        // View customer details
        function viewCustomer(customerId) {
            database.ref('creditCustomers/' + customerId).once('value').then(snapshot => {
                const customer = snapshot.val();
                if (!customer) return;
                
                currentCreditCustomerId = customerId;
                
                // Get customer transactions
                database.ref('creditTransactions').orderByChild('customerId').equalTo(customerId).once('value')
                    .then(transactionsSnapshot => {
                        const transactions = transactionsSnapshot.val();
                        let totalCredit = 0;
                        let totalPaid = 0;
                        let totalDue = 0;
                        
                        const modalBody = document.getElementById('customerModalBody');
                        modalBody.innerHTML = `
                            <div class="form-group">
                                <label>Customer Name</label>
                                <p>${customer.name}</p>
                            </div>
                            <div class="form-group">
                                <label>Contact Number</label>
                                <p>${customer.contact}</p>
                            </div>
                            <div class="form-group">
                                <label>Address</label>
                                <p>${customer.address || 'N/A'}</p>
                            </div>
                            <div class="form-group">
                                <label>Credit Limit</label>
                                <p>Rf ${customer.creditLimit?.toFixed(2) || '0.00'}</p>
                            </div>
                            <div class="form-group">
                                <label>Credit Days</label>
                                <p>${customer.creditDays || defaultCreditDays} days</p>
                            </div>
                            <div class="form-group">
                                <label>Status</label>
                                <p>${customer.status || 'active'}</p>
                            </div>
                            <div class="credit-details">
                                <h3>Credit Summary</h3>
                        `;
                        
                        if (transactions) {
                            Object.values(transactions).forEach(transaction => {
                                totalCredit += transaction.amount || 0;
                                
                                if (transaction.status === 'paid') {
                                    totalPaid += transaction.amount || 0;
                                } else {
                                    totalDue += transaction.amount || 0;
                                }
                            });
                            
                            modalBody.innerHTML += `
                                <p>Total Credit: Rf ${totalCredit.toFixed(2)}</p>
                                <p>Total Paid: Rf ${totalPaid.toFixed(2)}</p>
                                <p>Total Due: Rf ${totalDue.toFixed(2)}</p>
                                <p>Available Credit: Rf ${(customer.creditLimit - totalDue).toFixed(2)}</p>
                            `;
                            
                            // Show payment history
                            modalBody.innerHTML += `
                                <div class="payment-history">
                                    <h4>Payment History</h4>
                            `;
                            
                            Object.entries(transactions).forEach(([id, transaction]) => {
                                const statusClass = transaction.status === 'paid' ? 'status-paid' : 
                                                  new Date(transaction.dueDate) < new Date() ? 'status-overdue' : 'status-pending';
                                
                                modalBody.innerHTML += `
                                    <div class="payment-item">
                                        <div>
                                            <strong>${transaction.orderNumber}</strong>
                                            <br>Due: ${transaction.dueDate}
                                            <br>Amount: Rf ${transaction.amount?.toFixed(2) || '0.00'}
                                        </div>
                                        <div>
                                            <span class="credit-status ${statusClass}">${transaction.status || 'pending'}</span>
                                        </div>
                                    </div>
                                `;
                            });
                            
                            modalBody.innerHTML += `</div>`;
                        } else {
                            modalBody.innerHTML += `
                                <p>No credit transactions found</p>
                            `;
                        }
                        
                        modalBody.innerHTML += `</div>`;
                        
                        customerModal.style.display = 'block';
                    });
            });
        }

        // Delete customer
        function deleteCustomer(customerId) {
            if (confirm('Are you sure you want to delete this customer? This will not delete their credit transactions.')) {
                database.ref('creditCustomers/' + customerId).remove()
                    .then(() => {
                        showNotification('Customer deleted successfully!');
                        loadCreditCustomers();
                    })
                    .catch(error => {
                        showNotification('Error deleting customer: ' + error.message, 'error');
                    });
            }
        }

        // Load credit transactions
        function loadCreditTransactions() {
            if (!userAccess.includes('credit')) return;
            
            const statusFilter = document.getElementById('creditStatusFilter').value;
            const dateFrom = document.getElementById('creditDateFrom').value;
                       const dateTo = document.getElementById('creditDateTo').value;
            
            database.ref('creditTransactions').once('value').then(snapshot => {
                const transactions = snapshot.val();
                creditTable.innerHTML = '';
                
                if (transactions) {
                    Object.entries(transactions).forEach(([id, transaction]) => {
                        // Apply status filter
                        if (statusFilter) {
                            if (statusFilter === 'overdue') {
                                if (transaction.status === 'paid' || new Date(transaction.dueDate) >= new Date()) {
                                    return;
                                }
                            } else if (transaction.status !== statusFilter) {
                                return;
                            }
                        }
                        
                        // Apply date filters
                        const transactionDate = new Date(transaction.createdAt).toISOString().split('T')[0];
                        if (dateFrom && transactionDate < dateFrom) return;
                        if (dateTo && transactionDate > dateTo) return;
                        
                        const statusClass = transaction.status === 'paid' ? 'status-paid' : 
                                          new Date(transaction.dueDate) < new Date() ? 'status-overdue' : 'status-pending';
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${transaction.orderNumber || 'N/A'}</td>
                            <td>${transaction.customerName || 'N/A'}</td>
                            <td>${new Date(transaction.createdAt).toLocaleDateString() || 'N/A'}</td>
                            <td>Rf ${transaction.amount?.toFixed(2) || '0.00'}</td>
                            <td>Rf ${transaction.paid?.toFixed(2) || '0.00'}</td>
                            <td>Rf ${transaction.due?.toFixed(2) || '0.00'}</td>
                            <td>${transaction.dueDate || 'N/A'}</td>
                            <td><span class="credit-status ${statusClass}">${transaction.status || 'pending'}</span></td>
                            <td class="action-buttons">
                                <button class="btn btn-info record-payment" data-id="${id}">Payment</button>
                                <button class="btn btn-secondary view-credit-details" data-id="${id}">Details</button>
                            </td>
                        `;
                        creditTable.appendChild(row);
                        
                        // Add event listener to payment button
                        row.querySelector('.record-payment').addEventListener('click', () => {
                            currentCreditInvoiceId = id;
                            showPaymentForm(id);
                        });
                        
                        // Add event listener to details button
                        row.querySelector('.view-credit-details').addEventListener('click', () => {
                            viewCreditDetails(id);
                        });
                    });
                }
            });
        }

        // View credit details
        function viewCreditDetails(transactionId) {
            database.ref('creditTransactions/' + transactionId).once('value').then(snapshot => {
                const transaction = snapshot.val();
                if (!transaction) return;
                
                const modalBody = document.getElementById('creditCustomerModalBody');
                modalBody.innerHTML = `
                    <div class="credit-summary-card">
                        <h3>Credit Details</h3>
                        <div class="form-group">
                            <label>Invoice Number</label>
                            <p>${transaction.orderNumber || 'N/A'}</p>
                        </div>
                        <div class="form-group">
                            <label>Customer</label>
                            <p>${transaction.customerName || 'N/A'}</p>
                        </div>
                        <div class="form-group">
                            <label>Total Amount</label>
                            <p>Rf ${transaction.amount?.toFixed(2) || '0.00'}</p>
                        </div>
                        <div class="form-group">
                            <label>Amount Paid</label>
                            <p>Rf ${transaction.paid?.toFixed(2) || '0.00'}</p>
                        </div>
                        <div class="form-group">
                            <label>Amount Due</label>
                            <p>Rf ${transaction.due?.toFixed(2) || '0.00'}</p>
                        </div>
                        <div class="form-group">
                            <label>Due Date</label>
                            <p>${transaction.dueDate || 'N/A'}</p>
                        </div>
                        <div class="form-group">
                            <label>Status</label>
                            <p><span class="credit-status ${transaction.status === 'paid' ? 'status-paid' : new Date(transaction.dueDate) < new Date() ? 'status-overdue' : 'status-pending'}">${transaction.status || 'pending'}</span></p>
                        </div>
                    </div>
                    
                    <div class="credit-actions">
                        <button class="btn btn-info" id="settleCreditBtn" data-id="${transactionId}">Settle Credit</button>
                        <button class="btn btn-danger" id="deleteCreditBtn" data-id="${transactionId}">Delete</button>
                    </div>
                `;
                
                // Add event listeners
                document.getElementById('settleCreditBtn').addEventListener('click', () => {
                    settleCreditTransaction(transactionId);
                });
                
                document.getElementById('deleteCreditBtn').addEventListener('click', () => {
                    deleteCreditTransaction(transactionId);
                });
                
                creditCustomerModal.style.display = 'block';
            });
        }

        // Settle credit transaction
        function settleCreditTransaction(transactionId) {
            database.ref('creditTransactions/' + transactionId).once('value').then(snapshot => {
                const transaction = snapshot.val();
                if (!transaction) return;
                
                const amountDue = transaction.due || transaction.amount;
                
                // Update transaction to paid status
                database.ref('creditTransactions/' + transactionId).update({
                    paid: transaction.amount,
                    due: 0,
                    status: 'paid',
                    settledAt: new Date().toISOString()
                }).then(() => {
                    showNotification('Credit transaction settled successfully!');
                    creditCustomerModal.style.display = 'none';
                    loadCreditTransactions();
                    loadDashboardData();
                }).catch(error => {
                    showNotification('Error settling credit transaction: ' + error.message, 'error');
                });
            });
        }

        // Delete credit transaction
        function deleteCreditTransaction(transactionId) {
            if (confirm('Are you sure you want to delete this credit transaction? This action cannot be undone.')) {
                database.ref('creditTransactions/' + transactionId).remove()
                    .then(() => {
                        showNotification('Credit transaction deleted successfully!');
                        creditCustomerModal.style.display = 'none';
                        loadCreditTransactions();
                    })
                    .catch(error => {
                        showNotification('Error deleting credit transaction: ' + error.message, 'error');
                    });
            }
        }

        // Show payment form
        function showPaymentForm(transactionId = null) {
            const transactionIdToUse = transactionId || currentCreditInvoiceId;
            if (!transactionIdToUse) return;
            
            database.ref('creditTransactions/' + transactionIdToUse).once('value').then(snapshot => {
                const transaction = snapshot.val();
                if (!transaction) return;
                
                const modalBody = document.getElementById('creditPaymentModalBody');
                modalBody.innerHTML = `
                    <div class="form-group">
                        <label>Customer</label>
                        <p>${transaction.customerName || 'N/A'}</p>
                    </div>
                    <div class="form-group">
                        <label>Invoice #</label>
                        <p>${transaction.orderNumber || 'N/A'}</p>
                    </div>
                    <div class="form-group">
                        <label>Total Amount</label>
                        <p>Rf ${transaction.amount?.toFixed(2) || '0.00'}</p>
                    </div>
                    <div class="form-group">
                        <label>Amount Paid</label>
                        <p>Rf ${transaction.paid?.toFixed(2) || '0.00'}</p>
                    </div>
                    <div class="form-group">
                        <label>Amount Due</label>
                        <p>Rf ${transaction.due?.toFixed(2) || '0.00'}</p>
                    </div>
                    <div class="form-group">
                        <label for="paymentAmount">Payment Amount (Rf)</label>
                        <input type="number" id="paymentAmount" min="0" max="${transaction.due}" step="0.01" value="${transaction.due}" required>
                    </div>
                    <div class="form-group">
                        <label for="paymentDate">Payment Date</label>
                        <input type="date" id="paymentDate" required>
                    </div>
                    <div class="form-group">
                        <label for="paymentMethod">Payment Method</label>
                        <select id="paymentMethod" required>
                            <option value="cash">Cash</option>
                            <option value="bank-transfer">Bank Transfer</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="paymentNotes">Notes</label>
                        <textarea id="paymentNotes"></textarea>
                    </div>
                `;
                
                // Set today's date as default
                document.getElementById('paymentDate').value = new Date().toISOString().split('T')[0];
                
                creditPaymentModal.style.display = 'block';
            });
        }

        // Save payment
        function savePayment() {
            const paymentAmount = parseFloat(document.getElementById('paymentAmount').value);
            const paymentDate = document.getElementById('paymentDate').value;
            const paymentMethod = document.getElementById('paymentMethod').value;
            const paymentNotes = document.getElementById('paymentNotes').value;
            
            if (isNaN(paymentAmount) || paymentAmount <= 0) {
                showNotification('Please enter a valid payment amount', 'error');
                return;
            }
            
            database.ref('creditTransactions/' + currentCreditInvoiceId).once('value').then(snapshot => {
                const transaction = snapshot.val();
                if (!transaction) return;
                
                const newPaid = (transaction.paid || 0) + paymentAmount;
                const newDue = (transaction.due || transaction.amount) - paymentAmount;
                const newStatus = newDue <= 0 ? 'paid' : 'partial';
                
                // Update transaction
                database.ref('creditTransactions/' + currentCreditInvoiceId).update({
                    paid: newPaid,
                    due: newDue,
                    status: newStatus
                }).then(() => {
                    // Record payment history
                    const paymentRecord = {
                        transactionId: currentCreditInvoiceId,
                        amount: paymentAmount,
                        date: paymentDate,
                        method: paymentMethod,
                        notes: paymentNotes,
                        recordedBy: currentUser.username,
                        createdAt: new Date().toISOString()
                    };
                    
                    return database.ref('paymentHistory').push(paymentRecord);
                }).then(() => {
                    showNotification('Payment recorded successfully!');
                    creditPaymentModal.style.display = 'none';
                    loadCreditTransactions();
                    loadDashboardData();
                    
                    // If viewing customer details, refresh them
                    if (currentCreditCustomerId) {
                        viewCustomer(currentCreditCustomerId);
                    }
                }).catch(error => {
                    showNotification('Error recording payment: ' + error.message, 'error');
                });
            });
        }

        // Export to Excel
        function exportToExcel(type) {
            let data = [];
            let fileName = '';
            
            switch(type) {
                case 'orders':
                    data = getOrdersData();
                    fileName = 'orders_report.xlsx';
                    break;
                case 'expenses':
                    data = getExpensesData();
                    fileName = 'expenses_report.xlsx';
                    break;
                case 'salesReport':
                    data = getSalesReportData();
                    fileName = 'sales_report.xlsx';
                    break;
                case 'expensesReport':
                    data = getExpensesReportData();
                    fileName = 'expenses_report.xlsx';
                    break;
                case 'creditReport':
                    data = getCreditReportData();
                    fileName = 'credit_report.xlsx';
                    break;
                case 'balanceSheet':
                    data = getBalanceSheetData();
                    fileName = 'balance_sheet.xlsx';
                    break;
            }
            
            if (data.length === 0) {
                showNotification('No data to export', 'warning');
                return;
            }
            
            const worksheet = XLSX.utils.json_to_sheet(data);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Report');
            XLSX.writeFile(workbook, fileName);
            showNotification('Excel file exported successfully!');
        }

        // Export to PDF
        function exportToPdf(type) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            let data = [];
            let headers = [];
            let title = '';
            
            switch(type) {
                case 'orders':
                    data = getOrdersData();
                    headers = ['Order #', 'Customer', 'Phone', 'Date', 'Amount', 'Payment Method', 'Status'];
                    title = 'Orders Report';
                    break;
                case 'expenses':
                    data = getExpensesData();
                    headers = ['Date', 'Supplier', 'Invoice #', 'Purpose', 'Amount', 'Notes'];
                    title = 'Expenses Report';
                    break;
                case 'salesReport':
                    data = getSalesReportData();
                    headers = ['Date', 'Order #', 'Customer', 'Amount', 'Payment Method'];
                    title = 'Sales Report';
                    break;
                case 'expensesReport':
                    data = getExpensesReportData();
                    headers = ['Date', 'Supplier', 'Purpose', 'Amount', 'Invoice #'];
                    title = 'Expenses Report';
                    break;
                case 'creditReport':
                    data = getCreditReportData();
                    headers = ['Customer', 'Total Credit', 'Paid', 'Due', 'Overdue'];
                    title = 'Credit Report';
                    break;
                case 'balanceSheet':
                    data = getBalanceSheetData();
                    headers = ['Description', 'Amount'];
                    title = 'Balance Sheet';
                    break;
            }
            
            if (data.length === 0) {
                showNotification('No data to export', 'warning');
                return;
            }
            
            // Add title
            doc.setFontSize(16);
            doc.text(title, 14, 15);
            doc.setFontSize(10);
            doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 14, 22);
            
            // Prepare table data
            const tableData = data.map(row => {
                return headers.map(header => row[header] || '');
            });
            
            // Add table
            doc.autoTable({
                startY: 25,
                head: [headers],
                body: tableData
            });
            
            // Save the PDF
            doc.save(`${title.toLowerCase().replace(/\s/g, '_')}.pdf`);
            showNotification('PDF file exported successfully!');
        }

        // Get orders data for export
        function getOrdersData() {
            const ordersTable = document.getElementById('ordersTable');
            const data = [];
            
            // Get table rows
            ordersTable.querySelectorAll('tbody tr').forEach(row => {
                const cells = row.cells;
                const rowData = {
                    'Order #': cells[0].textContent.trim(),
                    'Customer': cells[1].textContent.trim(),
                    'Phone': cells[2].textContent.trim(),
                    'Date': cells[3].textContent.trim(),
                    'Amount': cells[4].textContent.trim(),
                    'Payment Method': cells[5].textContent.trim(),
                    'Status': cells[6].textContent.trim()
                };
                data.push(rowData);
            });
            
            return data;
        }

        // Get expenses data for export
        function getExpensesData() {
            const expensesTable = document.getElementById('expensesTable');
            const data = [];
            
            // Get table rows
            expensesTable.querySelectorAll('tbody tr').forEach(row => {
                const cells = row.cells;
                const rowData = {
                    'Date': cells[0].textContent.trim(),
                    'Supplier': cells[1].textContent.trim(),
                    'Invoice #': cells[2].textContent.trim(),
                    'Purpose': cells[3].textContent.trim(),
                    'Amount': cells[4].textContent.trim(),
                    'Notes': cells[5].textContent.trim()
                };
                data.push(rowData);
            });
            
            return data;
        }

        // Get sales report data for export
        function getSalesReportData() {
            const salesReportTable = document.getElementById('salesReportTable');
            const data = [];
            
            // Get table rows
            salesReportTable.querySelectorAll('tbody tr').forEach(row => {
                const cells = row.cells;
                const rowData = {
                    'Date': cells[0].textContent.trim(),
                    'Order #': cells[1].textContent.trim(),
                    'Customer': cells[2].textContent.trim(),
                    'Amount': cells[3].textContent.trim(),
                    'Payment Method': cells[4].textContent.trim()
                };
                data.push(rowData);
            });
            
            return data;
        }

        // Get expenses report data for export
        function getExpensesReportData() {
            const expensesReportTable = document.getElementById('expensesReportTable');
            const data = [];
            
            // Get table rows
            expensesReportTable.querySelectorAll('tbody tr').forEach(row => {
                const cells = row.cells;
                const rowData = {
                    'Date': cells[0].textContent.trim(),
                    'Supplier': cells[1].textContent.trim(),
                    'Purpose': cells[2].textContent.trim(),
                    'Amount': cells[3].textContent.trim(),
                    'Invoice #': cells[4].textContent.trim()
                };
                data.push(rowData);
            });
            
            return data;
        }

        // Get credit report data for export
        function getCreditReportData() {
            const creditReportTable = document.getElementById('creditReportTable');
            const data = [];
            
            // Get table rows
            creditReportTable.querySelectorAll('tbody tr').forEach(row => {
                const cells = row.cells;
                const rowData = {
                    'Customer': cells[0].textContent.trim(),
                    'Total Credit': cells[1].textContent.trim(),
                    'Paid': cells[2].textContent.trim(),
                    'Due': cells[3].textContent.trim(),
                    'Overdue': cells[4].textContent.trim()
                };
                data.push(rowData);
            });
            
            return data;
        }

        // Get balance sheet data for export
        function getBalanceSheetData() {
            const data = [
                {
                    'Description': 'Total Revenue',
                    'Amount': balanceSheetRevenue.textContent
                },
                {
                    'Description': 'Total Expenses',
                    'Amount': balanceSheetExpenses.textContent
                },
                {
                    'Description': 'Credit Sales',
                    'Amount': balanceSheetCredit.textContent
                },
                {
                    'Description': 'Pending Credit',
                    'Amount': balanceSheetPending.textContent
                },
                {
                    'Description': 'Net Profit',
                    'Amount': balanceSheetNetProfit.textContent
                }
            ];
            
            return data;
        }

        // Initialize the admin panel when DOM is loaded
        document.addEventListener('DOMContentLoaded', initAdmin);
    </script>
</body>
</html>